<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PPM - Pengurusan Digital</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // CONFIGURATION
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwQDoFSx5gDD07lbAM44u8A-2CTRHgXuvHArkPluWUsnbnh3q8i89v_yFNiwjRq_1Ce/exec";
        
        const AVATARS = Array.from({ length: 30 }, (_, i) => 
            `https://api.dicebear.com/7.x/notionists/svg?seed=${i + 150}&backgroundColor=b6e3f4,c0aede,d1d4f9`
        );

        // ==========================================
        // HELPER FUNCTIONS
        // ==========================================
        const formatTime12Hour = (time24) => {
            if (!time24) return '-';
            const [hours, minutes] = time24.split(':');
            let hour = parseInt(hours);
            const ampm = hour >= 12 ? 'p.m.' : 'a.m.';
            hour = hour % 12 || 12;
            return `${hour}.${minutes} ${ampm}`;
        };

        const getDayNumber = (dayName) => {
            const days = {
                'Isnin': 1,
                'Selasa': 2,
                'Rabu': 3,
                'Khamis': 4,
                'Jumaat': 5,
                'Sabtu': 6,
                'Ahad': 7
            };
            return days[dayName] || 0;
        };

        // ==========================================
        // ICON COMPONENT
        // ==========================================
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconHtml, setIconHtml] = useState("");
            
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    const iconData = window.lucide.icons[name];
                    
                    const content = iconData.map(([tag, attrs]) => {
                        const attrStr = Object.entries(attrs)
                            .map(([k, v]) => `${k}="${v}"`)
                            .join(' ');
                        return `<${tag} ${attrStr}></${tag}>`;
                    }).join('');

                    const svg = `
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            width="${size}" 
                            height="${size}" 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke="currentColor" 
                            stroke-width="2" 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            class="lucide lucide-${name.toLowerCase()} ${className}"
                        >
                            ${content}
                        </svg>
                    `;
                    setIconHtml(svg);
                }
            }, [name, size, className]);

            return (
                <span 
                    className="inline-flex items-center justify-center" 
                    dangerouslySetInnerHTML={{ __html: iconHtml }} 
                />
            );
        };

        // ==========================================
        // STATUS BANNER COMPONENT
        // ==========================================
        const StatusBanner = ({ status }) => {
            if (status === 'Active') return null;
            
            const bannerConfig = {
                'Pending': {
                    bg: 'bg-orange-50 border-orange-200',
                    text: 'text-orange-700',
                    icon: 'Clock',
                    title: '‚è≥ AKAUN MENUNGGU KELULUSAN ADMIN',
                    message: 'Anda boleh melihat sistem tetapi tidak boleh membuat perubahan. Sila tunggu email pengesahan dari admin.'
                },
                'Suspended': {
                    bg: 'bg-red-50 border-red-200',
                    text: 'text-red-700',
                    icon: 'AlertCircle',
                    title: '‚ö†Ô∏è AKAUN ANDA TELAH DIGANTUNG',
                    message: 'Akaun anda dalam status gantungan. Anda boleh melihat sistem tetapi tidak boleh membuat sebarang perubahan. Sila hubungi admin untuk maklumat lanjut.'
                },
                'Deleted': {
                    bg: 'bg-slate-50 border-slate-200',
                    text: 'text-slate-700',
                    icon: 'XCircle',
                    title: '‚ùå AKAUN TELAH DIHAPUSKAN',
                    message: 'Akaun ini telah dihapuskan. Sila hubungi admin jika ini adalah kesilapan.'
                }
            };
            
            const config = bannerConfig[status] || bannerConfig['Pending'];
            
            return (
                <div className={`${config.bg} border-2 ${config.text} rounded-2xl p-6 mb-6 animate-in fade-in duration-500`}>
                    <div className="flex items-start gap-4">
                        <Icon name={config.icon} size={24} className="flex-shrink-0 mt-1" />
                        <div>
                            <h3 className="font-black text-lg mb-2">{config.title}</h3>
                            <p className="text-sm font-medium opacity-90">{config.message}</p>
                        </div>
                    </div>
                </div>
            );
        };

/* PART 2A */

        
        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================
        function App() {
            // State Management
            const [page, setPage] = useState('landing'); 
            const [sidebarHidden, setSidebarHidden] = useState(true);
            const [subPage, setSubPage] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [reports, setReports] = useState([]);
            const [settings, setSettings] = useState({ 
                locations: ["Kelas", "Asrama", "Padang", "Dewan", "Kantin"], 
                gpks: [] 
            });
            const [notification, setNotification] = useState(null);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const [savedUsername, setSavedUsername] = useState("");

            // Initialize App
            useEffect(() => {
                const saved = localStorage.getItem('ppm_user');
                if (saved) {
                    const u = JSON.parse(saved);
                    setReports([]);
                    setUser(u);
                    setPage('app');
                    fetchReports(u);
                }
                fetchInitialData();
            }, []);

            // Notification Handler
            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            // API Call Handler
            const callAPI = async (action, payload) => {
                setLoading(true);
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        body: JSON.stringify({ action, payload })
                    });
                    const res = await response.json();
                    setLoading(false);
                    return res;
                } catch (err) {
                    setLoading(false);
                    notify("Gagal menyambung ke database. Pastikan GAS di-deploy sebagai 'Anyone'.", "error");
                    return { success: false };
                }
            };

            // Fetch Initial Data
            const fetchInitialData = async () => {
                const res = await callAPI('getInitialData', {});
                if (res.success) {
                    setSettings(prev => ({ ...prev, ...res }));
                }
            };

            // Fetch Reports
            const fetchReports = async (currUser) => {
                const res = await callAPI('getReports', { 
                    userId: currUser.uid, 
                    role: currUser.role 
                });
                if (res.success) {
                    setReports(res.reports);
                }
            };

            // ==========================================
            // AUTHENTICATION HANDLERS
            // ==========================================
            const handleLogin = async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                
                setReports([]);
                
                const res = await callAPI('login', data);
                if (res.success) {
                    setUser(res.user);
                    localStorage.setItem('ppm_user', JSON.stringify(res.user));
                    setPage('app');
                    fetchReports(res.user);
                } else {
                    notify(res.message, "error");
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                
                if (data.password.length !== 12) {
                    return notify("Password mesti tepat 12 aksara!", "error");
                }
                
                data.role = data.position === 'GPK' ? 'GPK' : 'User';
                if (data.username === 'admin') {
                    data.role = 'Admin';
                }

                const res = await callAPI('signup', data);
                if (res.success) {
                    notify(res.message || "Pendaftaran berjaya! Sila login.");
                    setPage('login');
                } else {
                    notify(res.message, "error");
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('ppm_user');
                setUser(null);
                setReports([]); 
                setPage('landing');
            };

            // ==========================================
            // UI COMPONENTS
            // ==========================================
            const SidebarItem = ({ id, icon, label, roles }) => {
                if (roles && !roles.includes(user?.role)) return null;
                
                const isActive = subPage === id;
                return (
                    <button 
                        onClick={() => {
                            setSubPage(id);
                            if (window.innerWidth < 768) setSidebarHidden(true);
                        }}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all ${
                            isActive 
                                ? 'bg-indigo-600 text-white shadow-lg' 
                                : 'text-slate-600 hover:bg-slate-50'
                        }`}
                    >
                        <Icon name={icon} size={20} />
                        <span className="text-sm font-bold">{label}</span>
                    </button>
                );
            };

            const AvatarPicker = ({ current, onSelect, onClose }) => (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[300] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-[40px] shadow-2xl p-8 animate-in fade-in duration-300">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black text-slate-800">Pilih Avatar Profil</h3>
                            <button 
                                onClick={onClose} 
                                className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"
                            >
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        <div className="grid grid-cols-4 gap-3 max-h-[400px] overflow-y-auto no-scrollbar p-2">
                            {AVATARS.map((url, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => onSelect(url)}
                                    className={`aspect-square rounded-2xl overflow-hidden border-4 transition-all hover:scale-105 ${
                                        current === url 
                                            ? 'border-indigo-600 bg-indigo-50 shadow-lg' 
                                            : 'border-slate-100'
                                    }`}
                                >
                                    <img src={url} className="w-full h-full object-cover" alt={`Avatar ${i + 1}`} />
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            // ==========================================
            // DASHBOARD COMPONENT
            // ==========================================
            const Dashboard = () => (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-slate-800">Ringkasan Prestasi</h2>
                        <div className="text-sm font-medium text-slate-500 bg-white px-4 py-2 rounded-full border border-slate-100 shadow-sm">
                            {new Date().toLocaleDateString('ms-MY', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="FileText" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">{reports.length}</span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Jumlah Laporan</p>
                        </div>

                        <div className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="CheckCircle" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">
                                    {reports.filter(r => r.status === 'Reviewed').length}
                                </span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Telah Disemak</p>
                        </div>

                        <div className="bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="Clock" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">
                                    {reports.filter(r => r.status === 'Pending').length}
                                </span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Menunggu Semakan</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2">
                            <Icon name="TrendingUp" size={20} className="text-indigo-600"/>
                            Aktiviti Terkini
                        </h3>
                        {reports.length === 0 ? (
                            <div className="text-center py-12 text-slate-400">
                                <Icon name="Inbox" size={48} className="mx-auto mb-3 opacity-30"/>
                                <p className="font-medium">Tiada laporan lagi</p>
                                <p className="text-sm">Mulakan dengan jana laporan baharu</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {reports.slice(0, 5).map(r => (
                                    <div 
                                        key={r.id} 
                                        className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl hover:bg-slate-100 transition-colors"
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`w-3 h-3 rounded-full ${
                                                r.status === 'Reviewed' ? 'bg-emerald-500' : 
                                                r.status === 'Pending' ? 'bg-orange-500' : 
                                                'bg-slate-300'
                                            }`}></div>
                                            <div>
                                                <p className="font-bold text-sm text-slate-800">
                                                    Minggu {r.week}, {r.year}
                                                </p>
                                                <p className="text-xs text-slate-500">
                                                    {r.logs?.length || 0} hari direkod
                                                </p>
                                            </div>
                                        </div>
                                        <span className={`text-xs font-black px-3 py-1 rounded-full ${
                                            r.status === 'Reviewed' 
                                                ? 'bg-emerald-100 text-emerald-700' 
                                                : r.status === 'Pending' 
                                                    ? 'bg-orange-100 text-orange-700' 
                                                    : 'bg-slate-200 text-slate-600'
                                        }`}>
                                            {r.status === 'Reviewed' ? '‚úì Disemak' : 
                                             r.status === 'Pending' ? '‚è≥ Pending' : 
                                             'üìù Draft'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            // ==========================================
            // TEMPLATE OPTIONS FOR DAILY LOGS
            // ==========================================
            const TEMPLATE_OPTIONS = {
                'PPM_KELAS_1': {
                    label: 'Template PPM Kelas Sesi 1 (Pagi)',
                    tasks: [
                        { m: "6:50 pg", t: "Menyambut kedatangan murid", c: "" },
                        { m: "", t: "Membuka pintu kelas", c: "" },
                        { m: "", t: "Menjaga kebersihan persekitaran", c: "" },
                        { m: "", t: "Membuka tingkap dan menyalakan lampu dan kipas", c: "" },
                        { m: "", t: "Memastikan peralatan sedia ada", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "7:05 pg", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "12:40 tgh", t: "Mengawasi murid beratur di kafetaria", c: "" },
                        { m: "", t: "Mengawasi murid semasa di kantin", c: "" },
                        { m: "", t: "Mengawasi murid solat Zohor", c: "" },
                        { m: "1:10 tgh", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "5:00 ptg", t: "Mengawasi murid pulang", c: "" },
                        { m: "", t: "Memastikan murid selamat pulang", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                },
                
                'PPM_KELAS_2': {
                    label: 'Template PPM Kelas Sesi 2 (Petang)',
                    tasks: [
                        { m: "12:50 tgh", t: "Menyambut kedatangan murid", c: "" },
                        { m: "", t: "Membuka pintu kelas", c: "" },
                        { m: "", t: "Menjaga kebersihan persekitaran", c: "" },
                        { m: "", t: "Membuka tingkap dan menyalakan lampu dan kipas", c: "" },
                        { m: "", t: "Memastikan peralatan sedia ada", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "1:05 tgh", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "4:30 ptg", t: "Mengawasi murid solat Asar", c: "" },
                        { m: "5:00 ptg", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "7:00 mlm", t: "Mengawasi murid pulang", c: "" },
                        { m: "", t: "Memastikan murid selamat pulang", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                },
                
                'SYIF_PAGI': {
                    label: 'Template Syif Pagi (Asrama)',
                    tasks: [
                        { m: "5:20 pg", t: "Tiba di sekolah", c: "" },
                        { m: "5:30 pg", t: "Membangunkan murid", c: "" },
                        { m: "", t: "Membantu murid menguruskan keperluan diri", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Subuh berjemaah", c: "" },
                        { m: "", t: "Mengawasi murid semasa belajar mengaji", c: "" },
                        { m: "6:30 pg", t: "Memantau murid semasa sarapan pagi", c: "" },
                        { m: "", t: "Memantau dan bersama-sama murid beriadah di kawasan asrama", c: "" },
                        { m: "", t: "Membantu murid menguruskan keperluan diri", c: "" },
                        { m: "7:00 pg", t: "Mengiringi murid ke sekolah", c: "" },
                        { m: "", t: "Mengemas bilik tidur dan ruang bilik air murid", c: "" },
                        { m: "", t: "Mencuci pakaian murid", c: "" },
                        { m: "9:00 pg", t: "Rehat", c: "" },
                        { m: "11:00 pg", t: "Menyediakan makanan untuk makan tengah hari", c: "" },
                        { m: "12:30 tgh", t: "Membimbing murid semasa makan tengah hari", c: "" },
                        { m: "12:50 tgh", t: "Tamat Syif Pagi", c: "Serah tugas kepada syif petang" }
                    ]
                },
                
                'SYIF_PETANG': {
                    label: 'Template Syif Petang (Asrama)',
                    tasks: [
                        { m: "12:50 tgh", t: "Memantau dan bersama-sama murid mengemas bilik masing-masing", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Zohor berjemaah", c: "" },
                        { m: "", t: "Beriadah bersama murid sambil melakukan aktiviti kecergasan asrama", c: "" },
                        { m: "4:00 ptg", t: "Memantau murid semasa minum petang", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Asar berjemaah", c: "" },
                        { m: "", t: "Beriadah bersama murid", c: "" },
                        { m: "6:00 ptg", t: "Memantau murid mengurus diri", c: "" },
                        { m: "", t: "Mencuci dan menjemur pakaian", c: "" },
                        { m: "", t: "Memantau murid semasa makan malam", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Maghrib berjemaah", c: "" },
                        { m: "8:00 mlm", t: "Rehat", c: "" },
                        { m: "9:00 mlm", t: "Memantau dan bersama-sama murid beriadah di bilik TV", c: "" },
                        { m: "", t: "Memantau murid semasa minum malam", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Isyak berjemaah", c: "" },
                        { m: "", t: "Mengagihkan pakaian murid", c: "" },
                        { m: "", t: "Memantau murid ke tandas dan menggosok gigi", c: "" },
                        { m: "", t: "Memastikan murid masuk tidur", c: "" },
                        { m: "10:00 mlm", t: "Tamat Syif Petang", c: "Serah tugas kepada syif malam" }
                    ]
                },
                
                'SYIF_MALAM': {
                    label: 'Template Syif Malam (Asrama)',
                    tasks: [
                        { m: "9:50 mlm", t: "Tiba di sekolah", c: "" },
                        { m: "10:00 mlm", t: "Membimbing dan memastikan murid ke tandas untuk memberus gigi serta bersuci sebelum masuk tidur", c: "" },
                        { m: "", t: "Memastikan murid tidur dan lampu ditutup", c: "" },
                        { m: "", t: "Mencuci bekas air dan peralatan lain yang berkaitan", c: "" },
                        { m: "", t: "Memasak air untuk tambahan", c: "" },
                        { m: "", t: "Menggosok pakaian sekolah murid", c: "" },
                        { m: "", t: "Memastikan keperluan murid iaitu pakaian dan peralatan sekolah mencukupi dan tersedia", c: "" },
                        { m: "", t: "Membuat rondaan dan memastikan pintu masuk asrama telah berkunci", c: "" },
                        { m: "1:00 pg", t: "Rehat", c: "" },
                        { m: "2:00 pg", t: "Membuat rondaan setiap bilik dan memantau persekitaran asrama dari masa ke semasa", c: "" },
                        { m: "5:30 pg", t: "Mengejutkan murid bangun tidur", c: "Serah tugas kepada syif pagi" }
                    ]
                },
                
                'PPM_PRA': {
                    label: 'Template PPM Pra',
                    tasks: [
                        { m: "7:05 pg", t: "Membuka kelas dan menyambut kedatangan murid", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "", t: "Mengawasi murid sebelum kehadiran guru", c: "" },
                        { m: "", t: "Menyediakan minum pagi", c: "Contoh: Biskut Oat + Susu" },
                        { m: "", t: "Menyediakan sarapan", c: "Contoh: Nasi Ayam + Buah Epal" },
                        { m: "", t: "Mengurus murid semasa dan selepas makan", c: "" },
                        { m: "", t: "Mengawasi murid semasa aktiviti menggosok gigi", c: "" },
                        { m: "", t: "Membantu guru semasa pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid semasa ke tandas", c: "" },
                        { m: "", t: "Mengawasi murid semasa aktiviti di luar kelas", c: "" },
                        { m: "5:20 ptg", t: "Mengawasi murid ketika pulang", c: "" },
                        { m: "", t: "Mencuci dan mengemas peralatan makan murid", c: "" },
                        { m: "", t: "Mencuci dan mengemas ruang dapur, kelas dan tandas", c: "" },
                        { m: "", t: "Membersih ruang persekitaran luar kelas", c: "" },
                        { m: "", t: "Merancang penyediaan menu untuk hari berikutnya", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                }
            };

/* PART 2B */

            
        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================
        function App() {
            // State Management
            const [page, setPage] = useState('landing'); 
            const [sidebarHidden, setSidebarHidden] = useState(true);
            const [subPage, setSubPage] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [reports, setReports] = useState([]);
            const [settings, setSettings] = useState({ 
                locations: ["Kelas", "Asrama", "Padang", "Dewan", "Kantin"], 
                gpks: [] 
            });
            const [notification, setNotification] = useState(null);
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const [savedUsername, setSavedUsername] = useState("");

            // Initialize App
            useEffect(() => {
                const saved = localStorage.getItem('ppm_user');
                if (saved) {
                    const u = JSON.parse(saved);
                    setReports([]);
                    setUser(u);
                    setPage('app');
                    fetchReports(u);
                }
                fetchInitialData();
            }, []);

            // Notification Handler
            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            // API Call Handler
            const callAPI = async (action, payload) => {
                setLoading(true);
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        body: JSON.stringify({ action, payload })
                    });
                    const res = await response.json();
                    setLoading(false);
                    return res;
                } catch (err) {
                    setLoading(false);
                    notify("Gagal menyambung ke database. Pastikan GAS di-deploy sebagai 'Anyone'.", "error");
                    return { success: false };
                }
            };

            // Fetch Initial Data
            const fetchInitialData = async () => {
                const res = await callAPI('getInitialData', {});
                if (res.success) {
                    setSettings(prev => ({ ...prev, ...res }));
                }
            };

            // Fetch Reports
            const fetchReports = async (currUser) => {
                const res = await callAPI('getReports', { 
                    userId: currUser.uid, 
                    role: currUser.role 
                });
                if (res.success) {
                    setReports(res.reports);
                }
            };

            // ==========================================
            // AUTHENTICATION HANDLERS
            // ==========================================
            const handleLogin = async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                
                setReports([]);
                
                const res = await callAPI('login', data);
                if (res.success) {
                    setUser(res.user);
                    localStorage.setItem('ppm_user', JSON.stringify(res.user));
                    setPage('app');
                    fetchReports(res.user);
                } else {
                    notify(res.message, "error");
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                
                if (data.password.length !== 12) {
                    return notify("Password mesti tepat 12 aksara!", "error");
                }
                
                data.role = data.position === 'GPK' ? 'GPK' : 'User';
                if (data.username === 'admin') {
                    data.role = 'Admin';
                }

                const res = await callAPI('signup', data);
                if (res.success) {
                    notify(res.message || "Pendaftaran berjaya! Sila login.");
                    setPage('login');
                } else {
                    notify(res.message, "error");
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('ppm_user');
                setUser(null);
                setReports([]); 
                setPage('landing');
            };

            // ==========================================
            // UI COMPONENTS
            // ==========================================
            const SidebarItem = ({ id, icon, label, roles }) => {
                if (roles && !roles.includes(user?.role)) return null;
                
                const isActive = subPage === id;
                return (
                    <button 
                        onClick={() => {
                            setSubPage(id);
                            if (window.innerWidth < 768) setSidebarHidden(true);
                        }}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all ${
                            isActive 
                                ? 'bg-indigo-600 text-white shadow-lg' 
                                : 'text-slate-600 hover:bg-slate-50'
                        }`}
                    >
                        <Icon name={icon} size={20} />
                        <span className="text-sm font-bold">{label}</span>
                    </button>
                );
            };

            const AvatarPicker = ({ current, onSelect, onClose }) => (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[300] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-[40px] shadow-2xl p-8 animate-in fade-in duration-300">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black text-slate-800">Pilih Avatar Profil</h3>
                            <button 
                                onClick={onClose} 
                                className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"
                            >
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        <div className="grid grid-cols-4 gap-3 max-h-[400px] overflow-y-auto no-scrollbar p-2">
                            {AVATARS.map((url, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => onSelect(url)}
                                    className={`aspect-square rounded-2xl overflow-hidden border-4 transition-all hover:scale-105 ${
                                        current === url 
                                            ? 'border-indigo-600 bg-indigo-50 shadow-lg' 
                                            : 'border-slate-100'
                                    }`}
                                >
                                    <img src={url} className="w-full h-full object-cover" alt={`Avatar ${i + 1}`} />
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            // ==========================================
            // DASHBOARD COMPONENT
            // ==========================================
            const Dashboard = () => (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <div className="flex items-center justify-between">
                        <h2 className="text-2xl font-bold text-slate-800">Ringkasan Prestasi</h2>
                        <div className="text-sm font-medium text-slate-500 bg-white px-4 py-2 rounded-full border border-slate-100 shadow-sm">
                            {new Date().toLocaleDateString('ms-MY', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="FileText" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">{reports.length}</span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Jumlah Laporan</p>
                        </div>

                        <div className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="CheckCircle" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">
                                    {reports.filter(r => r.status === 'Reviewed').length}
                                </span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Telah Disemak</p>
                        </div>

                        <div className="bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-3xl shadow-xl">
                            <div className="flex items-center justify-between mb-4">
                                <Icon name="Clock" size={32} className="opacity-80"/>
                                <span className="text-4xl font-black">
                                    {reports.filter(r => r.status === 'Pending').length}
                                </span>
                            </div>
                            <p className="text-sm font-bold opacity-90">Menunggu Semakan</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2">
                            <Icon name="TrendingUp" size={20} className="text-indigo-600"/>
                            Aktiviti Terkini
                        </h3>
                        {reports.length === 0 ? (
                            <div className="text-center py-12 text-slate-400">
                                <Icon name="Inbox" size={48} className="mx-auto mb-3 opacity-30"/>
                                <p className="font-medium">Tiada laporan lagi</p>
                                <p className="text-sm">Mulakan dengan jana laporan baharu</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {reports.slice(0, 5).map(r => (
                                    <div 
                                        key={r.id} 
                                        className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl hover:bg-slate-100 transition-colors"
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`w-3 h-3 rounded-full ${
                                                r.status === 'Reviewed' ? 'bg-emerald-500' : 
                                                r.status === 'Pending' ? 'bg-orange-500' : 
                                                'bg-slate-300'
                                            }`}></div>
                                            <div>
                                                <p className="font-bold text-sm text-slate-800">
                                                    Minggu {r.week}, {r.year}
                                                </p>
                                                <p className="text-xs text-slate-500">
                                                    {r.logs?.length || 0} hari direkod
                                                </p>
                                            </div>
                                        </div>
                                        <span className={`text-xs font-black px-3 py-1 rounded-full ${
                                            r.status === 'Reviewed' 
                                                ? 'bg-emerald-100 text-emerald-700' 
                                                : r.status === 'Pending' 
                                                    ? 'bg-orange-100 text-orange-700' 
                                                    : 'bg-slate-200 text-slate-600'
                                        }`}>
                                            {r.status === 'Reviewed' ? '‚úì Disemak' : 
                                             r.status === 'Pending' ? '‚è≥ Pending' : 
                                             'üìù Draft'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            // ==========================================
            // TEMPLATE OPTIONS FOR DAILY LOGS
            // ==========================================
            const TEMPLATE_OPTIONS = {
                'PPM_KELAS_1': {
                    label: 'Template PPM Kelas Sesi 1 (Pagi)',
                    tasks: [
                        { m: "6:50 pg", t: "Menyambut kedatangan murid", c: "" },
                        { m: "", t: "Membuka pintu kelas", c: "" },
                        { m: "", t: "Menjaga kebersihan persekitaran", c: "" },
                        { m: "", t: "Membuka tingkap dan menyalakan lampu dan kipas", c: "" },
                        { m: "", t: "Memastikan peralatan sedia ada", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "7:05 pg", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "12:40 tgh", t: "Mengawasi murid beratur di kafetaria", c: "" },
                        { m: "", t: "Mengawasi murid semasa di kantin", c: "" },
                        { m: "", t: "Mengawasi murid solat Zohor", c: "" },
                        { m: "1:10 tgh", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "5:00 ptg", t: "Mengawasi murid pulang", c: "" },
                        { m: "", t: "Memastikan murid selamat pulang", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                },
                
                'PPM_KELAS_2': {
                    label: 'Template PPM Kelas Sesi 2 (Petang)',
                    tasks: [
                        { m: "12:50 tgh", t: "Menyambut kedatangan murid", c: "" },
                        { m: "", t: "Membuka pintu kelas", c: "" },
                        { m: "", t: "Menjaga kebersihan persekitaran", c: "" },
                        { m: "", t: "Membuka tingkap dan menyalakan lampu dan kipas", c: "" },
                        { m: "", t: "Memastikan peralatan sedia ada", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "1:05 tgh", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "4:30 ptg", t: "Mengawasi murid solat Asar", c: "" },
                        { m: "5:00 ptg", t: "Membantu dalam pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid pergi ke tandas", c: "" },
                        { m: "", t: "Membantu membersihkan kawasan sekeliling", c: "" },
                        { m: "7:00 mlm", t: "Mengawasi murid pulang", c: "" },
                        { m: "", t: "Memastikan murid selamat pulang", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                },
                
                'SYIF_PAGI': {
                    label: 'Template Syif Pagi (Asrama)',
                    tasks: [
                        { m: "5:20 pg", t: "Tiba di sekolah", c: "" },
                        { m: "5:30 pg", t: "Membangunkan murid", c: "" },
                        { m: "", t: "Membantu murid menguruskan keperluan diri", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Subuh berjemaah", c: "" },
                        { m: "", t: "Mengawasi murid semasa belajar mengaji", c: "" },
                        { m: "6:30 pg", t: "Memantau murid semasa sarapan pagi", c: "" },
                        { m: "", t: "Memantau dan bersama-sama murid beriadah di kawasan asrama", c: "" },
                        { m: "", t: "Membantu murid menguruskan keperluan diri", c: "" },
                        { m: "7:00 pg", t: "Mengiringi murid ke sekolah", c: "" },
                        { m: "", t: "Mengemas bilik tidur dan ruang bilik air murid", c: "" },
                        { m: "", t: "Mencuci pakaian murid", c: "" },
                        { m: "9:00 pg", t: "Rehat", c: "" },
                        { m: "11:00 pg", t: "Menyediakan makanan untuk makan tengah hari", c: "" },
                        { m: "12:30 tgh", t: "Membimbing murid semasa makan tengah hari", c: "" },
                        { m: "12:50 tgh", t: "Tamat Syif Pagi", c: "Serah tugas kepada syif petang" }
                    ]
                },
                
                'SYIF_PETANG': {
                    label: 'Template Syif Petang (Asrama)',
                    tasks: [
                        { m: "12:50 tgh", t: "Memantau dan bersama-sama murid mengemas bilik masing-masing", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Zohor berjemaah", c: "" },
                        { m: "", t: "Beriadah bersama murid sambil melakukan aktiviti kecergasan asrama", c: "" },
                        { m: "4:00 ptg", t: "Memantau murid semasa minum petang", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Asar berjemaah", c: "" },
                        { m: "", t: "Beriadah bersama murid", c: "" },
                        { m: "6:00 ptg", t: "Memantau murid mengurus diri", c: "" },
                        { m: "", t: "Mencuci dan menjemur pakaian", c: "" },
                        { m: "", t: "Memantau murid semasa makan malam", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Maghrib berjemaah", c: "" },
                        { m: "8:00 mlm", t: "Rehat", c: "" },
                        { m: "9:00 mlm", t: "Memantau dan bersama-sama murid beriadah di bilik TV", c: "" },
                        { m: "", t: "Memantau murid semasa minum malam", c: "" },
                        { m: "", t: "Membimbing murid berwudhuk dan solat Isyak berjemaah", c: "" },
                        { m: "", t: "Mengagihkan pakaian murid", c: "" },
                        { m: "", t: "Memantau murid ke tandas dan menggosok gigi", c: "" },
                        { m: "", t: "Memastikan murid masuk tidur", c: "" },
                        { m: "10:00 mlm", t: "Tamat Syif Petang", c: "Serah tugas kepada syif malam" }
                    ]
                },
                
                'SYIF_MALAM': {
                    label: 'Template Syif Malam (Asrama)',
                    tasks: [
                        { m: "9:50 mlm", t: "Tiba di sekolah", c: "" },
                        { m: "10:00 mlm", t: "Membimbing dan memastikan murid ke tandas untuk memberus gigi serta bersuci sebelum masuk tidur", c: "" },
                        { m: "", t: "Memastikan murid tidur dan lampu ditutup", c: "" },
                        { m: "", t: "Mencuci bekas air dan peralatan lain yang berkaitan", c: "" },
                        { m: "", t: "Memasak air untuk tambahan", c: "" },
                        { m: "", t: "Menggosok pakaian sekolah murid", c: "" },
                        { m: "", t: "Memastikan keperluan murid iaitu pakaian dan peralatan sekolah mencukupi dan tersedia", c: "" },
                        { m: "", t: "Membuat rondaan dan memastikan pintu masuk asrama telah berkunci", c: "" },
                        { m: "1:00 pg", t: "Rehat", c: "" },
                        { m: "2:00 pg", t: "Membuat rondaan setiap bilik dan memantau persekitaran asrama dari masa ke semasa", c: "" },
                        { m: "5:30 pg", t: "Mengejutkan murid bangun tidur", c: "Serah tugas kepada syif pagi" }
                    ]
                },
                
                'PPM_PRA': {
                    label: 'Template PPM Pra',
                    tasks: [
                        { m: "7:05 pg", t: "Membuka kelas dan menyambut kedatangan murid", c: "" },
                        { m: "", t: "Merekod kehadiran murid", c: "" },
                        { m: "", t: "Mengawasi murid sebelum kehadiran guru", c: "" },
                        { m: "", t: "Menyediakan minum pagi", c: "Contoh: Biskut Oat + Susu" },
                        { m: "", t: "Menyediakan sarapan", c: "Contoh: Nasi Ayam + Buah Epal" },
                        { m: "", t: "Mengurus murid semasa dan selepas makan", c: "" },
                        { m: "", t: "Mengawasi murid semasa aktiviti menggosok gigi", c: "" },
                        { m: "", t: "Membantu guru semasa pengajaran dan pembelajaran", c: "" },
                        { m: "", t: "Mengawasi murid semasa ke tandas", c: "" },
                        { m: "", t: "Mengawasi murid semasa aktiviti di luar kelas", c: "" },
                        { m: "5:20 ptg", t: "Mengawasi murid ketika pulang", c: "" },
                        { m: "", t: "Mencuci dan mengemas peralatan makan murid", c: "" },
                        { m: "", t: "Mencuci dan mengemas ruang dapur, kelas dan tandas", c: "" },
                        { m: "", t: "Membersih ruang persekitaran luar kelas", c: "" },
                        { m: "", t: "Merancang penyediaan menu untuk hari berikutnya", c: "" },
                        { m: "", t: "Memastikan kelas teratur, kemas dan selamat sebelum pulang", c: "" }
                    ]
                }
            };


/* PART 2C */
            
            // ==========================================
            // JANA LAPORAN COMPONENT
            // ==========================================
            const JanaLaporan = () => {
                const [view, setView] = useState('list');
                const [activeReport, setActiveReport] = useState(null);
                const [showLogForm, setShowLogForm] = useState(false);
                const [editingLog, setEditingLog] = useState(null);

                const handleCreateFolder = async (e) => {
                    e.preventDefault();
                    const d = Object.fromEntries(new FormData(e.target));
                    const res = await callAPI('saveWeeklyFolder', { ...d, userId: user.uid });
                    if (res.success) {
                        notify("Folder mingguan berjaya dicipta!");
                        fetchReports(user);
                        setView('list');
                    } else {
                        notify(res.message, "error");
                    }
                };

                const handleAddLog = async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    
                    const taskRows = [];
                    let idx = 0;
                    while (fd.has(`m${idx}`)) {
                        const m = fd.get(`m${idx}`);
                        const t = fd.get(`t${idx}`);
                        const c = fd.get(`c${idx}`);
                        if (m || t || c) {
                            taskRows.push({ m, t, c });
                        }
                        idx++;
                    }

                    const payload = {
                        reportId: activeReport.reportId,
                        userId: user.uid,
                        date: fd.get('date'),
                        day: fd.get('day'),
                        location: fd.get('location'),
                        attendance: fd.get('attendance'),
                        startTime: formatTime12Hour(fd.get('startTime')),
                        endTime: formatTime12Hour(fd.get('endTime')),
                        tasks: taskRows
                    };

                    const res = await callAPI('saveDailyLog', payload);
                    if (res.success) {
                        notify("Log harian ditambah!");
                        fetchReports(user);
                        setShowLogForm(false);
                    } else {
                        notify(res.message || "Gagal menyimpan log", "error");
                    }
                };

                const handleDeleteLog = async (logId) => {
                    if (window.confirm("Hapus log ini? Tindakan tidak boleh dibatalkan.")) {
                        const res = await callAPI('deleteDailyLog', { logId });
                        if (res.success) {
                            notify("Log berjaya dihapus!");
                            fetchReports(user);
                        } else {
                            notify(res.message || "Gagal hapus log", "error");
                        }
                    }
                };

                const handleEditLog = (log) => {
                    setEditingLog(log);
                    setShowLogForm(true);
                };

                const handleUpdateLog = async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    
                    const taskRows = [];
                    let idx = 0;
                    while (fd.has(`m${idx}`)) {
                        const m = fd.get(`m${idx}`);
                        const t = fd.get(`t${idx}`);
                        const c = fd.get(`c${idx}`);
                        if (m || t || c) {
                            taskRows.push({ m, t, c });
                        }
                        idx++;
                    }

                    const payload = {
                        logId: editingLog.logId,
                        date: fd.get('date'),
                        day: fd.get('day'),
                        location: fd.get('location'),
                        attendance: fd.get('attendance'),
                        startTime: formatTime12Hour(fd.get('startTime')),
                        endTime: formatTime12Hour(fd.get('endTime')),
                        tasks: taskRows
                    };

                    const res = await callAPI('updateDailyLog', payload);
                    if (res.success) {
                        notify("Log berjaya dikemaskini!");
                        fetchReports(user);
                        setShowLogForm(false);
                        setEditingLog(null);
                    } else {
                        notify(res.message || "Gagal update log", "error");
                    }
                };

                const handleUnreport = async (id) => {
                    if (window.confirm("Tarik semula laporan ini ke status Draft? Anda boleh edit semula selepas itu.")) {
                        const res = await callAPI('unreportReport', { reportId: id });
                        if (res.success) {
                            notify("Laporan berjaya ditarik semula! Status: Draft");
                            fetchReports(user);
                            if (activeReport && activeReport.reportId === id) {
                                setActiveReport({...activeReport, status: 'Draft'});
                            }
                        } else {
                            notify(res.message || "Gagal tarik semula laporan", "error");
                        }
                    }
                };

                const confirmSubmit = async (id) => {
                    if (window.confirm("Adakah anda pasti? Laporan akan dihantar untuk semakan GPK.")) {
                        const res = await callAPI('submitReport', { reportId: id });
                        if (res.success) {
                            notify("Laporan berjaya dihantar!");
                            fetchReports(user);
                        }
                    }
                };

                // Create Folder View
                if (view === 'createFolder') {
                    return (
                        <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100 mt-10">
                            <h3 className="text-xl font-black mb-6 flex items-center">
                                <Icon name="Plus" className="mr-2 text-indigo-600"/> 
                                Cipta Tapak Minggu
                            </h3>
                            <form onSubmit={handleCreateFolder} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">
                                        Tahun
                                    </label>
                                    <input 
                                        name="year" 
                                        type="number" 
                                        defaultValue={new Date().getFullYear()} 
                                        min="2020" 
                                        max="2050" 
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">
                                        Minggu Ke
                                    </label>
                                    <input 
                                        name="weekNum" 
                                        type="number" 
                                        min="1" 
                                        max="56" 
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        required 
                                    />
                                </div>
                                <div className="flex gap-3 pt-4">
                                    <button 
                                        type="button" 
                                        onClick={() => setView('list')} 
                                        className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        type="submit" 
                                        className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors"
                                    >
                                        Cipta Folder
                                    </button>
                                </div>
                            </form>
                        </div>
                    );
                }

                // View Logs View
                if (view === 'view' && activeReport) {
                    return (
                        <div className="space-y-6">
                            {showLogForm && (
                                <DailyLogForm 
                                    onSubmit={editingLog ? handleUpdateLog : handleAddLog}
                                    onClose={() => {
                                        setShowLogForm(false);
                                        setEditingLog(null);
                                    }}
                                    settings={settings}
                                    editingLog={editingLog}
                                />
                            )}

                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <button 
                                        onClick={() => {setView('list'); setActiveReport(null);}} 
                                        className="flex items-center text-indigo-600 hover:text-indigo-700 font-bold mb-2"
                                    >
                                        <Icon name="ArrowLeft" size={18} className="mr-1"/> 
                                        Kembali
                                    </button>
                                    <h3 className="text-2xl font-black text-slate-800">
                                        Minggu {activeReport.weekNum} ({activeReport.year})
                                    </h3>
                                    <p className="text-sm text-slate-500 mt-1">
                                        Status: <span className="font-bold">{activeReport.status}</span>
                                    </p>
                                </div>
                                {activeReport.status === 'Draft' && user.role === 'User' && (
                                    <button 
                                        onClick={() => {
                                            setEditingLog(null);
                                            setShowLogForm(true);
                                        }}
                                        disabled={user.status !== 'Active'}
                                        className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg ${
                                            user.status === 'Active'
                                                ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                        }`}
                                    >
                                        <Icon name="Plus" size={18}/> 
                                        Tambah Log Harian
                                    </button>
                                )}
                            </div>

                            <div className="space-y-4">
                                {activeReport.logs?.sort((a, b) => getDayNumber(a.day) - getDayNumber(b.day)).map((log, idx) => (
                                    <div key={idx} className="bg-white border-2 border-slate-300 rounded-2xl overflow-hidden shadow-sm">
                                        <div className="bg-slate-100 px-6 py-4 border-b-2 border-slate-300 flex justify-between items-center">
                                            <h5 className="font-black text-slate-800 text-lg">
                                                Laporan Harian #{idx + 1} - {log.day}
                                                <span className="ml-3 text-sm text-slate-500 font-medium">
                                                    ({new Date(log.date).toLocaleDateString('ms-MY', { 
                                                        day: 'numeric', 
                                                        month: 'short', 
                                                        year: 'numeric' 
                                                    })})
                                                </span>
                                            </h5>
                                            {activeReport.status === 'Draft' && user.role === 'User' && (
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => handleEditLog(log)}
                                                        disabled={user.status !== 'Active'}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${
                                                            user.status === 'Active'
                                                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Icon name="Edit" size={14}/> 
                                                        Edit
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDeleteLog(log.logId)}
                                                        disabled={user.status !== 'Active'}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${
                                                            user.status === 'Active'
                                                                ? 'bg-red-600 text-white hover:bg-red-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Icon name="Trash2" size={14}/> 
                                                        Hapus
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <div className="p-6">
                                            <div className="bg-slate-800 px-4 py-2 rounded-t-lg -mx-6 -mt-6 mb-4">
                                                <h6 className="font-bold text-white uppercase text-xs tracking-wider flex items-center">
                                                    <Icon name="Calendar" size={14} className="mr-2"/> 
                                                    Maklumat Asas
                                                </h6>
                                            </div>

                                            <table className="w-full text-sm mb-6">
                                                <tbody>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs w-1/4">
                                                            Nama Penuh
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {user.fullName}
                                                        </td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Tarikh
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {new Date(log.date).toLocaleDateString('ms-MY', { 
                                                                day: '2-digit', 
                                                                month: '2-digit', 
                                                                year: 'numeric' 
                                                            })}
                                                            <span className="ml-2 text-slate-500">({log.day})</span>
                                                        </td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Hari
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.day}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Lokasi
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.location}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Kehadiran
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.attendance}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Masa Masuk
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {formatTime12Hour(log.startTime)}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Masa Keluar
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {formatTime12Hour(log.endTime)}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left border-t-2 border-slate-300 min-w-[600px]">
                                                    <thead>
                                                        <tr className="bg-slate-700 text-white">
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '15%'}}>
                                                                Masa
                                                            </th>
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '45%'}}>
                                                                Tugasan
                                                            </th>
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '40%'}}>
                                                                Catatan
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {log.tasks?.map((t, ti) => (
                                                            <tr key={ti} className="bg-white hover:bg-slate-50">
                                                                <td className="p-3 border border-slate-300 font-bold text-indigo-700">
                                                                    {t.m || '-'}
                                                                </td>
                                                                <td className="p-3 border border-slate-300 font-medium text-slate-800">
                                                                    {t.t || '-'}
                                                                </td>
                                                                <td className="p-3 border border-slate-300 text-slate-600 italic">
                                                                    {t.c || '-'}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {activeReport.logs?.length === 0 && (
                                    <div className="p-20 text-center border-2 border-dashed rounded-3xl text-slate-300 font-medium bg-white">
                                        Tiada log harian ditemui. Klik butang tambah di atas.
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // List View (Default)
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-black text-slate-800">Janaan Laporan Mingguan</h3>
                            {user.role === 'User' && (
                                <button 
                                    onClick={() => setView('createFolder')} 
                                    disabled={user.status !== 'Active'}
                                    className={`px-5 py-2.5 rounded-xl font-bold flex items-center shadow-lg transition-transform ${
                                        user.status === 'Active' 
                                            ? 'bg-indigo-600 text-white shadow-indigo-100 hover:-translate-y-1' 
                                            : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    <Icon name="Plus" size={18} className="mr-2"/> 
                                    Cipta Folder
                                </button>
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {reports
                                .sort((a, b) => {
                                    if (b.year !== a.year) return b.year - a.year;
                                    return b.weekNum - a.weekNum;
                                })
                                .map((r) => (
                                    <div 
                                        key={r.reportId} 
                                        className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-xl transition-shadow border-t-4 border-t-indigo-500"
                                    >
                                        <div className="p-6">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h4 className="text-2xl font-black text-slate-800">
                                                        Minggu {r.weekNum}
                                                    </h4>
                                                    <p className="text-sm font-medium text-slate-400 italic">
                                                        Sesi {r.year}
                                                    </p>
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ${
                                                    r.status === 'Draft' ? 'bg-slate-100 text-slate-500' : 
                                                    r.status === 'Submitted' ? 'bg-indigo-100 text-indigo-700' : 
                                                    'bg-emerald-100 text-emerald-700'
                                                }`}>
                                                    {r.status}
                                                </span>
                                            </div>
                                            <div className="space-y-3 pt-4 border-t border-slate-50">
                                                <div className="flex items-center text-slate-500 text-xs font-medium">
                                                    <Icon name="Calendar" size={14} className="mr-2 text-indigo-400" /> 
                                                    ID: {r.reportId}
                                                </div>
                                                {r.submittedAt && (
                                                    <div className="flex items-center text-slate-500 text-xs font-medium">
                                                        <Icon name="Clock" size={14} className="mr-2 text-indigo-400" /> 
                                                        Hantar: {new Date(r.submittedAt).toLocaleString()}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className={`grid ${
                                                r.status === 'Draft' ? 'grid-cols-2' : 
                                                r.status === 'Submitted' ? 'grid-cols-2' : 
                                                'grid-cols-1'
                                            } gap-3 mt-6`}>
                                                <button 
                                                    onClick={() => {
                                                        setActiveReport(r); 
                                                        setView('view');
                                                    }} 
                                                    className="py-2.5 bg-indigo-50 text-indigo-700 rounded-xl font-bold text-xs hover:bg-indigo-100 transition-colors"
                                                >
                                                    Lihat Log
                                                </button>
                                                
                                                {r.status === 'Draft' && user.role === 'User' && (
                                                    <button 
                                                        onClick={() => confirmSubmit(r.reportId)} 
                                                        disabled={user.status !== 'Active'}
                                                        className={`py-2.5 rounded-xl font-bold text-xs transition-colors ${
                                                            user.status === 'Active'
                                                                ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        Hantar
                                                    </button>
                                                )}
                                                
                                                {r.status === 'Submitted' && user.role === 'User' && (
                                                    <button 
                                                        onClick={() => handleUnreport(r.reportId)}
                                                        className="py-2.5 bg-orange-600 text-white rounded-xl font-bold text-xs hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                    >
                                                        <Icon name="RotateCcw" size={14}/>
                                                        Tarik Semula
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                );
            };

            // ==========================================
            // TASK CARD COMPONENT (Mobile-Friendly)
            // ==========================================
            const TaskCard = ({ index, task, onUpdate, onRemove, showRemove }) => {
                const handleTextareaChange = (e, field) => {
                    onUpdate(index, field, e.target.value);
                    e.target.style.height = 'auto';
                    e.target.style.height = e.target.scrollHeight + 'px';
                };

                return (
                    <div className="bg-white border-2 border-slate-200 rounded-2xl p-4 hover:border-indigo-300 transition-all shadow-sm hover:shadow-md">
                        <div className="flex items-start justify-between mb-3">
                            <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-black">
                                #{index + 1}
                            </span>
                            {showRemove && (
                                <button 
                                    type="button"
                                    onClick={() => onRemove(index)}
                                    className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"
                                >
                                    <Icon name="Trash2" size={16}/>
                                </button>
                            )}
                        </div>

                        <div className="space-y-3">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Waktu
                                </label>
                                <input 
                                    name={`m${index}`}
                                    type="text"
                                    value={task.m}
                                    onChange={(e) => onUpdate(index, 'm', e.target.value)}
                                    placeholder="Contoh: 07:00 - 09:00"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm font-bold"
                                />
                            </div>

                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Tugasan
                                </label>
                                <textarea 
                                    name={`t${index}`}
                                    value={task.t}
                                    onChange={(e) => handleTextareaChange(e, 't')}
                                    placeholder="Perihal tugasan utama..."
                                    rows="2"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm font-medium resize-none overflow-hidden"
                                />
                            </div>

                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Catatan
                                </label>
                                <textarea 
                                    name={`c${index}`}
                                    value={task.c}
                                    onChange={(e) => handleTextareaChange(e, 'c')}
                                    placeholder="Tambahan catatan (pilihan)"
                                    rows="1"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm italic text-slate-600 resize-none overflow-hidden"
                                />
                            </div>
                        </div>
                    </div>
                );
            };

/* PART 2D */

            
            // ==========================================
            // JANA LAPORAN COMPONENT
            // ==========================================
            const JanaLaporan = () => {
                const [view, setView] = useState('list');
                const [activeReport, setActiveReport] = useState(null);
                const [showLogForm, setShowLogForm] = useState(false);
                const [editingLog, setEditingLog] = useState(null);

                const handleCreateFolder = async (e) => {
                    e.preventDefault();
                    const d = Object.fromEntries(new FormData(e.target));
                    const res = await callAPI('saveWeeklyFolder', { ...d, userId: user.uid });
                    if (res.success) {
                        notify("Folder mingguan berjaya dicipta!");
                        fetchReports(user);
                        setView('list');
                    } else {
                        notify(res.message, "error");
                    }
                };

                const handleAddLog = async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    
                    const taskRows = [];
                    let idx = 0;
                    while (fd.has(`m${idx}`)) {
                        const m = fd.get(`m${idx}`);
                        const t = fd.get(`t${idx}`);
                        const c = fd.get(`c${idx}`);
                        if (m || t || c) {
                            taskRows.push({ m, t, c });
                        }
                        idx++;
                    }

                    const payload = {
                        reportId: activeReport.reportId,
                        userId: user.uid,
                        date: fd.get('date'),
                        day: fd.get('day'),
                        location: fd.get('location'),
                        attendance: fd.get('attendance'),
                        startTime: formatTime12Hour(fd.get('startTime')),
                        endTime: formatTime12Hour(fd.get('endTime')),
                        tasks: taskRows
                    };

                    const res = await callAPI('saveDailyLog', payload);
                    if (res.success) {
                        notify("Log harian ditambah!");
                        fetchReports(user);
                        setShowLogForm(false);
                    } else {
                        notify(res.message || "Gagal menyimpan log", "error");
                    }
                };

                const handleDeleteLog = async (logId) => {
                    if (window.confirm("Hapus log ini? Tindakan tidak boleh dibatalkan.")) {
                        const res = await callAPI('deleteDailyLog', { logId });
                        if (res.success) {
                            notify("Log berjaya dihapus!");
                            fetchReports(user);
                        } else {
                            notify(res.message || "Gagal hapus log", "error");
                        }
                    }
                };

                const handleEditLog = (log) => {
                    setEditingLog(log);
                    setShowLogForm(true);
                };

                const handleUpdateLog = async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    
                    const taskRows = [];
                    let idx = 0;
                    while (fd.has(`m${idx}`)) {
                        const m = fd.get(`m${idx}`);
                        const t = fd.get(`t${idx}`);
                        const c = fd.get(`c${idx}`);
                        if (m || t || c) {
                            taskRows.push({ m, t, c });
                        }
                        idx++;
                    }

                    const payload = {
                        logId: editingLog.logId,
                        date: fd.get('date'),
                        day: fd.get('day'),
                        location: fd.get('location'),
                        attendance: fd.get('attendance'),
                        startTime: formatTime12Hour(fd.get('startTime')),
                        endTime: formatTime12Hour(fd.get('endTime')),
                        tasks: taskRows
                    };

                    const res = await callAPI('updateDailyLog', payload);
                    if (res.success) {
                        notify("Log berjaya dikemaskini!");
                        fetchReports(user);
                        setShowLogForm(false);
                        setEditingLog(null);
                    } else {
                        notify(res.message || "Gagal update log", "error");
                    }
                };

                const handleUnreport = async (id) => {
                    if (window.confirm("Tarik semula laporan ini ke status Draft? Anda boleh edit semula selepas itu.")) {
                        const res = await callAPI('unreportReport', { reportId: id });
                        if (res.success) {
                            notify("Laporan berjaya ditarik semula! Status: Draft");
                            fetchReports(user);
                            if (activeReport && activeReport.reportId === id) {
                                setActiveReport({...activeReport, status: 'Draft'});
                            }
                        } else {
                            notify(res.message || "Gagal tarik semula laporan", "error");
                        }
                    }
                };

                const confirmSubmit = async (id) => {
                    if (window.confirm("Adakah anda pasti? Laporan akan dihantar untuk semakan GPK.")) {
                        const res = await callAPI('submitReport', { reportId: id });
                        if (res.success) {
                            notify("Laporan berjaya dihantar!");
                            fetchReports(user);
                        }
                    }
                };

                // Create Folder View
                if (view === 'createFolder') {
                    return (
                        <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100 mt-10">
                            <h3 className="text-xl font-black mb-6 flex items-center">
                                <Icon name="Plus" className="mr-2 text-indigo-600"/> 
                                Cipta Tapak Minggu
                            </h3>
                            <form onSubmit={handleCreateFolder} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">
                                        Tahun
                                    </label>
                                    <input 
                                        name="year" 
                                        type="number" 
                                        defaultValue={new Date().getFullYear()} 
                                        min="2020" 
                                        max="2050" 
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">
                                        Minggu Ke
                                    </label>
                                    <input 
                                        name="weekNum" 
                                        type="number" 
                                        min="1" 
                                        max="56" 
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        required 
                                    />
                                </div>
                                <div className="flex gap-3 pt-4">
                                    <button 
                                        type="button" 
                                        onClick={() => setView('list')} 
                                        className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        type="submit" 
                                        className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors"
                                    >
                                        Cipta Folder
                                    </button>
                                </div>
                            </form>
                        </div>
                    );
                }

                // View Logs View
                if (view === 'view' && activeReport) {
                    return (
                        <div className="space-y-6">
                            {showLogForm && (
                                <DailyLogForm 
                                    onSubmit={editingLog ? handleUpdateLog : handleAddLog}
                                    onClose={() => {
                                        setShowLogForm(false);
                                        setEditingLog(null);
                                    }}
                                    settings={settings}
                                    editingLog={editingLog}
                                />
                            )}

                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <button 
                                        onClick={() => {setView('list'); setActiveReport(null);}} 
                                        className="flex items-center text-indigo-600 hover:text-indigo-700 font-bold mb-2"
                                    >
                                        <Icon name="ArrowLeft" size={18} className="mr-1"/> 
                                        Kembali
                                    </button>
                                    <h3 className="text-2xl font-black text-slate-800">
                                        Minggu {activeReport.weekNum} ({activeReport.year})
                                    </h3>
                                    <p className="text-sm text-slate-500 mt-1">
                                        Status: <span className="font-bold">{activeReport.status}</span>
                                    </p>
                                </div>
                                {activeReport.status === 'Draft' && user.role === 'User' && (
                                    <button 
                                        onClick={() => {
                                            setEditingLog(null);
                                            setShowLogForm(true);
                                        }}
                                        disabled={user.status !== 'Active'}
                                        className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg ${
                                            user.status === 'Active'
                                                ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                        }`}
                                    >
                                        <Icon name="Plus" size={18}/> 
                                        Tambah Log Harian
                                    </button>
                                )}
                            </div>

                            <div className="space-y-4">
                                {activeReport.logs?.sort((a, b) => getDayNumber(a.day) - getDayNumber(b.day)).map((log, idx) => (
                                    <div key={idx} className="bg-white border-2 border-slate-300 rounded-2xl overflow-hidden shadow-sm">
                                        <div className="bg-slate-100 px-6 py-4 border-b-2 border-slate-300 flex justify-between items-center">
                                            <h5 className="font-black text-slate-800 text-lg">
                                                Laporan Harian #{idx + 1} - {log.day}
                                                <span className="ml-3 text-sm text-slate-500 font-medium">
                                                    ({new Date(log.date).toLocaleDateString('ms-MY', { 
                                                        day: 'numeric', 
                                                        month: 'short', 
                                                        year: 'numeric' 
                                                    })})
                                                </span>
                                            </h5>
                                            {activeReport.status === 'Draft' && user.role === 'User' && (
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => handleEditLog(log)}
                                                        disabled={user.status !== 'Active'}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${
                                                            user.status === 'Active'
                                                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Icon name="Edit" size={14}/> 
                                                        Edit
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDeleteLog(log.logId)}
                                                        disabled={user.status !== 'Active'}
                                                        className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 ${
                                                            user.status === 'Active'
                                                                ? 'bg-red-600 text-white hover:bg-red-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Icon name="Trash2" size={14}/> 
                                                        Hapus
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <div className="p-6">
                                            <div className="bg-slate-800 px-4 py-2 rounded-t-lg -mx-6 -mt-6 mb-4">
                                                <h6 className="font-bold text-white uppercase text-xs tracking-wider flex items-center">
                                                    <Icon name="Calendar" size={14} className="mr-2"/> 
                                                    Maklumat Asas
                                                </h6>
                                            </div>

                                            <table className="w-full text-sm mb-6">
                                                <tbody>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs w-1/4">
                                                            Nama Penuh
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {user.fullName}
                                                        </td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Tarikh
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {new Date(log.date).toLocaleDateString('ms-MY', { 
                                                                day: '2-digit', 
                                                                month: '2-digit', 
                                                                year: 'numeric' 
                                                            })}
                                                            <span className="ml-2 text-slate-500">({log.day})</span>
                                                        </td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Hari
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.day}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Lokasi
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.location}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Kehadiran
                                                        </td>
                                                        <td className="p-3 font-semibold">{log.attendance}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-300">
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Masa Masuk
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {formatTime12Hour(log.startTime)}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td className="p-3 border-r border-slate-300 bg-slate-50 font-bold uppercase text-xs">
                                                            Masa Keluar
                                                        </td>
                                                        <td className="p-3 font-semibold">
                                                            {formatTime12Hour(log.endTime)}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left border-t-2 border-slate-300 min-w-[600px]">
                                                    <thead>
                                                        <tr className="bg-slate-700 text-white">
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '15%'}}>
                                                                Masa
                                                            </th>
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '45%'}}>
                                                                Tugasan
                                                            </th>
                                                            <th className="p-3 border border-slate-300 font-bold uppercase" style={{width: '40%'}}>
                                                                Catatan
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {log.tasks?.map((t, ti) => (
                                                            <tr key={ti} className="bg-white hover:bg-slate-50">
                                                                <td className="p-3 border border-slate-300 font-bold text-indigo-700">
                                                                    {t.m || '-'}
                                                                </td>
                                                                <td className="p-3 border border-slate-300 font-medium text-slate-800">
                                                                    {t.t || '-'}
                                                                </td>
                                                                <td className="p-3 border border-slate-300 text-slate-600 italic">
                                                                    {t.c || '-'}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {activeReport.logs?.length === 0 && (
                                    <div className="p-20 text-center border-2 border-dashed rounded-3xl text-slate-300 font-medium bg-white">
                                        Tiada log harian ditemui. Klik butang tambah di atas.
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // List View (Default)
                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-black text-slate-800">Janaan Laporan Mingguan</h3>
                            {user.role === 'User' && (
                                <button 
                                    onClick={() => setView('createFolder')} 
                                    disabled={user.status !== 'Active'}
                                    className={`px-5 py-2.5 rounded-xl font-bold flex items-center shadow-lg transition-transform ${
                                        user.status === 'Active' 
                                            ? 'bg-indigo-600 text-white shadow-indigo-100 hover:-translate-y-1' 
                                            : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    <Icon name="Plus" size={18} className="mr-2"/> 
                                    Cipta Folder
                                </button>
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {reports
                                .sort((a, b) => {
                                    if (b.year !== a.year) return b.year - a.year;
                                    return b.weekNum - a.weekNum;
                                })
                                .map((r) => (
                                    <div 
                                        key={r.reportId} 
                                        className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-xl transition-shadow border-t-4 border-t-indigo-500"
                                    >
                                        <div className="p-6">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h4 className="text-2xl font-black text-slate-800">
                                                        Minggu {r.weekNum}
                                                    </h4>
                                                    <p className="text-sm font-medium text-slate-400 italic">
                                                        Sesi {r.year}
                                                    </p>
                                                </div>
                                                <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ${
                                                    r.status === 'Draft' ? 'bg-slate-100 text-slate-500' : 
                                                    r.status === 'Submitted' ? 'bg-indigo-100 text-indigo-700' : 
                                                    'bg-emerald-100 text-emerald-700'
                                                }`}>
                                                    {r.status}
                                                </span>
                                            </div>
                                            <div className="space-y-3 pt-4 border-t border-slate-50">
                                                <div className="flex items-center text-slate-500 text-xs font-medium">
                                                    <Icon name="Calendar" size={14} className="mr-2 text-indigo-400" /> 
                                                    ID: {r.reportId}
                                                </div>
                                                {r.submittedAt && (
                                                    <div className="flex items-center text-slate-500 text-xs font-medium">
                                                        <Icon name="Clock" size={14} className="mr-2 text-indigo-400" /> 
                                                        Hantar: {new Date(r.submittedAt).toLocaleString()}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className={`grid ${
                                                r.status === 'Draft' ? 'grid-cols-2' : 
                                                r.status === 'Submitted' ? 'grid-cols-2' : 
                                                'grid-cols-1'
                                            } gap-3 mt-6`}>
                                                <button 
                                                    onClick={() => {
                                                        setActiveReport(r); 
                                                        setView('view');
                                                    }} 
                                                    className="py-2.5 bg-indigo-50 text-indigo-700 rounded-xl font-bold text-xs hover:bg-indigo-100 transition-colors"
                                                >
                                                    Lihat Log
                                                </button>
                                                
                                                {r.status === 'Draft' && user.role === 'User' && (
                                                    <button 
                                                        onClick={() => confirmSubmit(r.reportId)} 
                                                        disabled={user.status !== 'Active'}
                                                        className={`py-2.5 rounded-xl font-bold text-xs transition-colors ${
                                                            user.status === 'Active'
                                                                ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        Hantar
                                                    </button>
                                                )}
                                                
                                                {r.status === 'Submitted' && user.role === 'User' && (
                                                    <button 
                                                        onClick={() => handleUnreport(r.reportId)}
                                                        className="py-2.5 bg-orange-600 text-white rounded-xl font-bold text-xs hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                    >
                                                        <Icon name="RotateCcw" size={14}/>
                                                        Tarik Semula
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                );
            };

            // ==========================================
            // TASK CARD COMPONENT (Mobile-Friendly)
            // ==========================================
            const TaskCard = ({ index, task, onUpdate, onRemove, showRemove }) => {
                const handleTextareaChange = (e, field) => {
                    onUpdate(index, field, e.target.value);
                    e.target.style.height = 'auto';
                    e.target.style.height = e.target.scrollHeight + 'px';
                };

                return (
                    <div className="bg-white border-2 border-slate-200 rounded-2xl p-4 hover:border-indigo-300 transition-all shadow-sm hover:shadow-md">
                        <div className="flex items-start justify-between mb-3">
                            <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-black">
                                #{index + 1}
                            </span>
                            {showRemove && (
                                <button 
                                    type="button"
                                    onClick={() => onRemove(index)}
                                    className="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"
                                >
                                    <Icon name="Trash2" size={16}/>
                                </button>
                            )}
                        </div>

                        <div className="space-y-3">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Waktu
                                </label>
                                <input 
                                    name={`m${index}`}
                                    type="text"
                                    value={task.m}
                                    onChange={(e) => onUpdate(index, 'm', e.target.value)}
                                    placeholder="Contoh: 07:00 - 09:00"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm font-bold"
                                />
                            </div>

                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Tugasan
                                </label>
                                <textarea 
                                    name={`t${index}`}
                                    value={task.t}
                                    onChange={(e) => handleTextareaChange(e, 't')}
                                    placeholder="Perihal tugasan utama..."
                                    rows="2"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm font-medium resize-none overflow-hidden"
                                />
                            </div>

                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">
                                    Catatan
                                </label>
                                <textarea 
                                    name={`c${index}`}
                                    value={task.c}
                                    onChange={(e) => handleTextareaChange(e, 'c')}
                                    placeholder="Tambahan catatan (pilihan)"
                                    rows="1"
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none text-sm italic text-slate-600 resize-none overflow-hidden"
                                />
                            </div>
                        </div>
                    </div>
                );
            };

            
            // ==========================================
            // USER MANAGEMENT COMPONENT
            // ==========================================
            const UserManagement = () => {
                const [allUsers, setAllUsers] = useState([]);
                const [filterStatus, setFilterStatus] = useState('All');
                const [searchQuery, setSearchQuery] = useState('');
                const [showPasswordFor, setShowPasswordFor] = useState(null);
                const [loadingUsers, setLoadingUsers] = useState(true);
                const [currentPage, setCurrentPage] = useState(1);
                const USERS_PER_PAGE = 20;

                useEffect(() => {
                    fetchAllUsers();
                }, []);

                const fetchAllUsers = async (retryCount = 0) => {
                    setLoadingUsers(true);
                    try {
                        const res = await callAPI('getAllUsersForAdmin', { requesterId: user.uid });
                        if (res.success) {
                            setAllUsers(res.users);
                            setLoadingUsers(false);
                        } else {
                            throw new Error(res.message || 'Gagal fetch data');
                        }
                    } catch (error) {
                        if (retryCount < 2) {
                            notify(`Mencuba semula... (${retryCount + 1}/2)`, "error");
                            setTimeout(() => fetchAllUsers(retryCount + 1), 2000);
                        } else {
                            setLoadingUsers(false);
                            notify("Gagal memuat data selepas 2 percubaan. Sila refresh halaman.", "error");
                        }
                    }
                };

                const handleApprove = async (userId) => {
                    if (window.confirm("Luluskan pengguna ini?")) {
                        const res = await callAPI('approveUser', { adminId: user.uid, userId });
                        if (res.success) {
                            notify("Pengguna berjaya diluluskan!");
                            await fetchAllUsers();
                        } else {
                            notify(res.message, "error");
                        }
                    }
                };

                const handleReject = async (userId) => {
                    if (window.confirm("Tolak dan hapus permohonan ini? Email penolakan akan dihantar.")) {
                        const res = await callAPI('rejectUser', { adminId: user.uid, userId });
                        if (res.success) {
                            notify("Permohonan ditolak dan email dihantar");
                            await fetchAllUsers();
                        } else {
                            notify(res.message, "error");
                        }
                    }
                };

                const handleSuspend = async (userId) => {
                    if (window.confirm("Gantung akaun ini? User masih boleh login tapi read-only.")) {
                        const res = await callAPI('suspendUser', { adminId: user.uid, userId });
                        if (res.success) {
                            notify("Akaun berjaya digantung");
                            await fetchAllUsers();
                        } else {
                            notify(res.message, "error");
                        }
                    }
                };

                const handleReactivate = async (userId) => {
                    if (window.confirm("Aktifkan semula akaun ini?")) {
                        const res = await callAPI('reactivateUser', { adminId: user.uid, userId });
                        if (res.success) {
                            notify("Akaun berjaya diaktifkan semula");
                            await fetchAllUsers();
                        } else {
                            notify(res.message, "error");
                        }
                    }
                };

                const handleDelete = async (userId) => {
                    if (window.confirm("AMARAN: Hapus akaun ini secara kekal? Laporan user akan kekal untuk audit trail.")) {
                        const res = await callAPI('softDeleteUser', { adminId: user.uid, userId });
                        if (res.success) {
                            notify("Akaun berjaya dihapuskan");
                            await fetchAllUsers();
                        } else {
                            notify(res.message, "error");
                        }
                    }
                };

                const filteredUsers = allUsers
                    .filter(u => filterStatus === 'All' || u.status === filterStatus)
                    .filter(u => 
                        u.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        u.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        u.email.toLowerCase().includes(searchQuery.toLowerCase())
                    );

                // Pagination calculations
                const totalPages = Math.ceil(filteredUsers.length / USERS_PER_PAGE);
                const startIndex = (currentPage - 1) * USERS_PER_PAGE;
                const endIndex = startIndex + USERS_PER_PAGE;
                const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

                // Reset to page 1 when filter/search changes
                useEffect(() => {
                    setCurrentPage(1);
                }, [filterStatus, searchQuery]);

                const pendingCount = allUsers.filter(u => u.status === 'Pending').length;

                return (
                    <div className="space-y-6">
                        {/* Header */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-black text-slate-800">Pengurusan Akaun</h2>
                                <p className="text-sm text-slate-500 mt-1">
                                    {pendingCount > 0 && (
                                        <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-bold">
                                            {pendingCount} Menunggu Kelulusan
                                        </span>
                                    )}
                                </p>
                            </div>

                            {/* Filters */}
                            <div className="flex flex-col md:flex-row gap-3">
                                <input 
                                    type="text"
                                    placeholder="üîç Cari nama, username, email..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="px-4 py-2 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                />
                                <select 
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="px-4 py-2 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none"
                                >
                                    <option value="All">Semua Status</option>
                                    <option value="Pending">‚è≥ Pending</option>
                                    <option value="Active">‚úÖ Active</option>
                                    <option value="Suspended">‚è∏Ô∏è Suspended</option>
                                    <option value="Deleted">üóëÔ∏è Deleted</option>
                                </select>
                            </div>
                        </div>

                        {/* Desktop Table */}
                        <div className="hidden md:block bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 border-b border-slate-100">
                                        <tr className="text-slate-400 text-xs font-black uppercase">
                                            <th className="px-6 py-4">Pengguna</th>
                                            <th className="px-6 py-4">Kata Laluan</th>
                                            <th className="px-6 py-4">Jawatan</th>
                                            <th className="px-6 py-4">GPK Penilai</th>
                                            <th className="px-6 py-4">Status</th>
                                            <th className="px-6 py-4 text-center">Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {loadingUsers ? (
                                            <tr>
                                                <td colSpan="6" className="py-20">
                                                    <div className="flex flex-col items-center justify-center">
                                                        <div className="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-4"></div>
                                                        <p className="text-slate-600 font-bold">Memuat data pengguna...</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        ) : paginatedUsers.map(u => (
                                            <tr key={u.uid} className="hover:bg-slate-50/30 transition-colors">
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center overflow-hidden">
                                                            {u.profilePic ? (
                                                                <img src={u.profilePic} className="w-full h-full object-cover" alt="" />
                                                            ) : (
                                                                <span className="text-indigo-600 font-bold text-sm uppercase">
                                                                    {u.fullName.substring(0,2)}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <p className="font-bold text-slate-800">{u.fullName}</p>
                                                            <p className="text-xs text-slate-400">@{u.username}</p>
                                                            <p className="text-xs text-slate-400">{u.email}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center gap-2">
                                                        <code className="bg-slate-100 px-2 py-1 rounded text-xs font-mono">
                                                            {showPasswordFor === u.uid ? u.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                                                        </code>
                                                        <button 
                                                            onClick={() => setShowPasswordFor(showPasswordFor === u.uid ? null : u.uid)}
                                                            className="p-1 hover:bg-slate-100 rounded transition-colors"
                                                        >
                                                            <Icon name={showPasswordFor === u.uid ? "EyeOff" : "Eye"} size={14} />
                                                        </button>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <span className="text-xs font-bold text-slate-600">{u.position}</span>
                                                    <p className="text-[10px] text-slate-400 uppercase">{u.role}</p>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <span className="text-xs text-slate-500">{u.reportingGpk || '-'}</span>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2.5 py-1 rounded-full text-xs font-black uppercase ${
                                                        u.status === 'Pending' ? 'bg-orange-100 text-orange-700' :
                                                        u.status === 'Active' ? 'bg-emerald-100 text-emerald-700' :
                                                        u.status === 'Suspended' ? 'bg-slate-100 text-slate-600' :
                                                        'bg-red-100 text-red-700'
                                                    }`}>
                                                        {u.status}
                                                    </span>
                                                    {u.approvedBy && (
                                                        <p className="text-[10px] text-slate-400 mt-1">
                                                            Oleh: {u.approvedBy}
                                                        </p>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="flex items-center justify-center gap-2 flex-wrap">
                                                        {u.status === 'Pending' && (
                                                            <>
                                                                <button 
                                                                    onClick={() => handleApprove(u.uid)}
                                                                    className="px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-700 flex items-center gap-1"
                                                                    title="Luluskan"
                                                                >
                                                                    <Icon name="CheckCircle" size={14}/> Lulus
                                                                </button>
                                                                <button 
                                                                    onClick={() => handleReject(u.uid)}
                                                                    className="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700 flex items-center gap-1"
                                                                    title="Tolak"
                                                                >
                                                                    <Icon name="XCircle" size={14}/> Tolak
                                                                </button>
                                                            </>
                                                        )}
                                                        {u.status === 'Active' && u.role !== 'Admin' && (
                                                            <button 
                                                                onClick={() => handleSuspend(u.uid)}
                                                                className="px-3 py-1.5 bg-orange-600 text-white rounded-lg text-xs font-bold hover:bg-orange-700 flex items-center gap-1"
                                                                title="Gantung"
                                                            >
                                                                <Icon name="Pause" size={14}/> Gantung
                                                            </button>
                                                        )}
                                                        {u.status === 'Suspended' && (
                                                            <button 
                                                                onClick={() => handleReactivate(u.uid)}
                                                                className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 flex items-center gap-1"
                                                                title="Aktif Semula"
                                                            >
                                                                <Icon name="Play" size={14}/> Aktif
                                                            </button>
                                                        )}
                                                        {u.role !== 'Admin' && u.status !== 'Deleted' && (
                                                            <button 
                                                                onClick={() => handleDelete(u.uid)}
                                                                className="px-3 py-1.5 bg-slate-600 text-white rounded-lg text-xs font-bold hover:bg-slate-700"
                                                                title="Hapus"
                                                            >
                                                                <Icon name="Trash2" size={14}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            {!loadingUsers && paginatedUsers.length === 0 && (
                                <div className="py-20 text-center text-slate-300 italic">
                                    Tiada pengguna dijumpai
                                </div>
                            )}
                        </div>

                        {/* Mobile Cards */}
                        <div className="md:hidden space-y-4">
                            {loadingUsers ? (
                                <div className="flex flex-col items-center justify-center py-20 bg-white rounded-2xl">
                                    <div className="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-4"></div>
                                    <p className="text-slate-600 font-bold">Memuat data pengguna...</p>
                                </div>
                            ) : paginatedUsers.map(u => (
                                <div key={u.uid} className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center overflow-hidden">
                                                {u.profilePic ? (
                                                    <img src={u.profilePic} className="w-full h-full object-cover" alt="" />
                                                ) : (
                                                    <span className="text-indigo-600 font-bold uppercase">
                                                        {u.fullName.substring(0,2)}
                                                    </span>
                                                )}
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-800">{u.fullName}</p>
                                                <p className="text-xs text-slate-400">@{u.username}</p>
                                            </div>
                                        </div>
                                        <span className={`px-2.5 py-1 rounded-full text-xs font-black uppercase ${
                                            u.status === 'Pending' ? 'bg-orange-100 text-orange-700' :
                                            u.status === 'Active' ? 'bg-emerald-100 text-emerald-700' :
                                            u.status === 'Suspended' ? 'bg-slate-100 text-slate-600' :
                                            'bg-red-100 text-red-700'
                                        }`}>
                                            {u.status}
                                        </span>
                                    </div>

                                    <div className="space-y-2 mb-4 text-xs">
                                        <div className="flex justify-between">
                                            <span className="text-slate-400 font-bold">Email:</span>
                                            <span className="text-slate-600">{u.email}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-slate-400 font-bold">Jawatan:</span>
                                            <span className="text-slate-600">{u.position}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-slate-400 font-bold">GPK:</span>
                                            <span className="text-slate-600">{u.reportingGpk || '-'}</span>
                                        </div>
                                    </div>

                                    <div className="flex gap-2 pt-3 border-t border-slate-50">
                                        {u.status === 'Pending' && (
                                            <>
                                                <button 
                                                    onClick={() => handleApprove(u.uid)}
                                                    className="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-xl text-xs font-bold hover:bg-emerald-700 flex items-center justify-center gap-1"
                                                >
                                                    <Icon name="CheckCircle" size={14}/> Lulus
                                                </button>
                                                <button 
                                                    onClick={() => handleReject(u.uid)}
                                                    className="px-3 py-2 bg-red-600 text-white rounded-xl text-xs font-bold hover:bg-red-700 flex items-center justify-center gap-1"
                                                >
                                                    <Icon name="XCircle" size={14}/> Tolak
                                                </button>
                                            </>
                                        )}
                                        {u.status === 'Active' && u.role !== 'Admin' && (
                                            <button 
                                                onClick={() => handleSuspend(u.uid)}
                                                className="flex-1 px-3 py-2 bg-orange-600 text-white rounded-xl text-xs font-bold hover:bg-orange-700 flex items-center justify-center gap-1"
                                            >
                                                <Icon name="Pause" size={14}/> Gantung
                                            </button>
                                        )}
                                        {u.status === 'Suspended' && (
                                            <button 
                                                onClick={() => handleReactivate(u.uid)}
                                                className="flex-1 px-3 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 flex items-center justify-center gap-1"
                                            >
                                                <Icon name="Play" size={14}/> Aktif
                                            </button>
                                        )}
                                        {u.role !== 'Admin' && u.status !== 'Deleted' && (
                                            <button 
                                                onClick={() => handleDelete(u.uid)}
                                                className="px-3 py-2 bg-slate-600 text-white rounded-xl text-xs font-bold hover:bg-slate-700 flex items-center justify-center gap-1"
                                            >
                                                <Icon name="Trash2" size={14}/> Hapus
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {!loadingUsers && paginatedUsers.length === 0 && (
                                <div className="py-20 text-center text-slate-300 italic bg-white rounded-2xl border-2 border-dashed">
                                    Tiada pengguna dijumpai
                                </div>
                            )}
                        </div>

                        {/* Pagination Controls */}
                        {!loadingUsers && filteredUsers.length > USERS_PER_PAGE && (
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4 mt-6 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div className="text-sm text-slate-600">
                                    Menunjukkan <span className="font-bold">{startIndex + 1}</span> hingga{' '}
                                    <span className="font-bold">{Math.min(endIndex, filteredUsers.length)}</span> daripada{' '}
                                    <span className="font-bold">{filteredUsers.length}</span> pengguna
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        className={`px-4 py-2 rounded-xl font-bold text-sm transition-all ${
                                            currentPage === 1
                                                ? 'bg-slate-100 text-slate-400 cursor-not-allowed'
                                                : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                        }`}
                                    >
                                        <Icon name="ChevronLeft" size={16} className="inline mr-1" />
                                        Sebelum
                                    </button>
                                    
                                    <div className="flex items-center gap-1">
                                        {[...Array(totalPages)].map((_, i) => {
                                            const pageNum = i + 1;
                                            if (
                                                pageNum === 1 ||
                                                pageNum === totalPages ||
                                                (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)
                                            ) {
                                                return (
                                                    <button
                                                        key={pageNum}
                                                        onClick={() => setCurrentPage(pageNum)}
                                                        className={`w-10 h-10 rounded-xl font-bold text-sm transition-all ${
                                                            currentPage === pageNum
                                                                ? 'bg-indigo-600 text-white shadow-lg'
                                                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                        }`}
                                                    >
                                                        {pageNum}
                                                    </button>
                                                );
                                            } else if (
                                                pageNum === currentPage - 2 ||
                                                pageNum === currentPage + 2
                                            ) {
                                                return <span key={pageNum} className="text-slate-400 px-1">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        className={`px-4 py-2 rounded-xl font-bold text-sm transition-all ${
                                            currentPage === totalPages
                                                ? 'bg-slate-100 text-slate-400 cursor-not-allowed'
                                                : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                        }`}
                                    >
                                        Seterus
                                        <Icon name="ChevronRight" size={16} className="inline ml-1" />
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // ==========================================
            // PROFILE PAGE COMPONENT
            // ==========================================
            const ProfilePage = ({ user, setUser, callAPI, notify }) => {
                const [isEditing, setIsEditing] = useState(false);
                const [showPicker, setShowPicker] = useState(false);
                const [formData, setFormData] = useState({ ...user });

                useEffect(() => {
                    setFormData({ ...user });
                }, [user]);

                const handleInputChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handleSave = async () => {
                    if (formData.password && formData.password.length !== 12) {
                        notify("Kata laluan mestilah tepat 12 aksara!", "error");
                        return;
                    }

                    const res = await callAPI('updateProfile', formData);
                    if (res.success) {
                        setUser(formData);
                        localStorage.setItem('ppm_user', JSON.stringify(formData));
                        setIsEditing(false);
                        notify("Profil anda berjaya dikemaskini secara menyeluruh!");
                    } else {
                        notify(res.message || "Gagal mengemaskini profil.", "error");
                    }
                };

                return (
                    <div className="max-w-3xl mx-auto bg-white rounded-[40px] shadow-sm border border-slate-100 overflow-hidden animate-in fade-in duration-500">
                        {showPicker && (
                            <AvatarPicker 
                                current={formData.profilePic} 
                                onSelect={(url) => { 
                                    setFormData({...formData, profilePic: url}); 
                                    setShowPicker(false); 
                                }} 
                                onClose={() => setShowPicker(false)} 
                            />
                        )}

                        <div className="h-48 bg-gradient-to-r from-indigo-600 to-blue-700 relative">
                            <div className="absolute -bottom-20 left-1/2 -translate-x-1/2 p-2 bg-white rounded-full shadow-2xl">
                                <div className="w-40 h-40 rounded-full bg-slate-100 flex items-center justify-center overflow-hidden border-4 border-white relative group">
                                    <img 
                                        src={formData.profilePic || AVATARS[0]} 
                                        className="w-full h-full object-cover" 
                                        alt="Profile" 
                                    />
                                    {isEditing && (
                                        <button 
                                            onClick={() => setShowPicker(true)} 
                                            className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center cursor-pointer transition-all"
                                        >
                                            <Icon name="Camera" size={28} className="text-white" />
                                            <span className="text-[10px] text-white font-bold uppercase">TUKAR FOTO</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="pt-24 pb-12 px-8 md:px-12">
                            {!isEditing ? (
                                <div className="space-y-8">
                                    <div className="text-center">
                                        <h2 className="text-3xl font-black text-slate-800">{user.fullName}</h2>
                                        <p className="text-indigo-600 font-bold uppercase text-sm tracking-widest">
                                            {user.position}
                                        </p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="p-5 bg-slate-50 rounded-3xl border border-slate-100">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-1">Username</p>
                                            <p className="font-bold text-slate-700">@{user.username}</p>
                                        </div>
                                        <div className="p-5 bg-slate-50 rounded-3xl border border-slate-100">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-1">Status Akaun</p>
                                            <span className={`inline-block px-3 py-1 rounded-full text-xs font-black uppercase mt-1 ${
                                                user.status === 'Active' ? 'bg-emerald-100 text-emerald-700' :
                                                user.status === 'Pending' ? 'bg-orange-100 text-orange-700' :
                                                user.status === 'Suspended' ? 'bg-red-100 text-red-700' :
                                                'bg-slate-100 text-slate-600'
                                            }`}>
                                                {user.status || 'Active'}
                                            </span>
                                        </div>
                                        <div className="p-5 bg-slate-50 rounded-3xl border border-slate-100">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-1">Emel</p>
                                            <p className="font-bold text-slate-700 truncate">{user.email || 'Tiada Emel'}</p>
                                        </div>
                                        <div className="p-5 bg-indigo-50 rounded-3xl border border-indigo-100 border-l-4 border-l-indigo-600">
                                            <p className="text-[10px] font-black text-indigo-400 uppercase mb-1">GPK Penilai</p>
                                            <p className="font-bold text-indigo-700">{user.reportingGpk || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setIsEditing(true)} 
                                        className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:-translate-y-0.5 transition-all"
                                    >
                                        SUNTING PROFIL PENUH
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-300">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-1">
                                            <label className="text-xs font-black text-slate-400 uppercase ml-2">Nama Penuh</label>
                                            <input 
                                                name="fullName" 
                                                value={formData.fullName} 
                                                onChange={handleInputChange} 
                                                className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs font-black text-slate-400 uppercase ml-2">Emel</label>
                                            <input 
                                                name="email" 
                                                type="email" 
                                                value={formData.email} 
                                                onChange={handleInputChange} 
                                                className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs font-black text-slate-400 uppercase ml-2">Kata Laluan (12 Aksara)</label>
                                            <input 
                                                name="password" 
                                                value={formData.password} 
                                                onChange={handleInputChange} 
                                                className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                maxLength={12} 
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs font-black text-slate-400 uppercase ml-2">Jawatan</label>
                                            <select 
                                                name="position" 
                                                value={formData.position} 
                                                onChange={handleInputChange} 
                                                className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none"
                                            >
                                                <option value="PPM KELAS">PPM KELAS</option>
                                                <option value="PPM ASRAMA">PPM ASRAMA</option>
                                                <option value="PPM PRA">PPM PRA</option>
                                                <option value="GPK">GPK</option>
                                            </select>
                                        </div>
                                        <div className="space-y-1 md:col-span-2">
                                            <label className="text-xs font-black text-slate-400 uppercase ml-2">GPK Penilai</label>
                                            <select 
                                                name="reportingGpk" 
                                                value={formData.reportingGpk} 
                                                onChange={handleInputChange} 
                                                className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none"
                                            >
                                                <option value="GPK PENTADBIRAN">GPK PENTADBIRAN</option>
                                                <option value="GPK HAL EHWAL MURID">GPK HAL EHWAL MURID</option>
                                                <option value="GPK KOKURIKULUM">GPK KOKURIKULUM</option>
                                                <option value="-">TIADA PENILAI</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="flex flex-col md:flex-row gap-3 pt-6">
                                        <button 
                                            onClick={handleSave} 
                                            className="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition-all"
                                        >
                                            SIMPAN PERUBAHAN
                                        </button>
                                        <button 
                                            onClick={() => { 
                                                setFormData({...user}); 
                                                setIsEditing(false); 
                                            }} 
                                            className="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-black hover:bg-slate-200 transition-all"
                                        >
                                            BATAL
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

/* PART 3 */

            
            // ==========================================
            // RENDER PAGES
            // ==========================================

            // Landing Page
            if (page === 'landing') {
                return (
                    <div className="min-h-screen bg-indigo-600 flex flex-col items-center justify-center p-6 text-white relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-96 h-96 bg-indigo-500 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2 opacity-50"></div>
                        <div className="absolute bottom-0 right-0 w-96 h-96 bg-blue-500 rounded-full blur-3xl translate-x-1/2 translate-y-1/2 opacity-50"></div>
                        
                        <div className="relative z-10 text-center max-w-2xl">
                            <div className="bg-white/10 w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-8 backdrop-blur-md border border-white/20">
                                <Icon name="FileText" size={48} className="text-white" />
                            </div>
                            <h1 className="text-6xl md:text-8xl font-black mb-4 tracking-tighter">
                                SISTEM<br/>PPM
                            </h1>
                            <p className="text-xl md:text-2xl font-medium opacity-80 mb-12">
                                Digitalisasi Laporan Pembantu Pengurusan Murid Sekolah Malaysia.
                            </p>
                            
                            <div className="flex flex-col md:flex-row gap-4 justify-center">
                                <button 
                                    onClick={() => setPage('login')} 
                                    className="px-10 py-4 bg-white text-indigo-700 font-black rounded-2xl shadow-2xl shadow-indigo-900/40 hover:scale-105 transition-transform"
                                >
                                    Log Masuk
                                </button>
                                <button 
                                    onClick={() => setPage('signup')} 
                                    className="px-10 py-4 bg-transparent border-2 border-white/40 text-white font-black rounded-2xl backdrop-blur-sm hover:bg-white/10 transition-colors"
                                >
                                    Daftar Akaun
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Login/Signup/Forgot Password Pages
            if (page === 'login' || page === 'signup' || page === 'forgot') {
                const isSignup = page === 'signup';
                const isForgot = page === 'forgot';
                
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row animate-in fade-in duration-500">
                        {/* Left Side - Info Panel */}
                        <div className="md:w-1/2 bg-indigo-600 p-12 flex flex-col justify-between text-white relative overflow-hidden">
                            <div className="relative z-10">
                                <button 
                                    onClick={() => { 
                                        setPage('landing'); 
                                        setShowPassword(false); 
                                    }} 
                                    className="flex items-center text-indigo-200 hover:text-white mb-12 font-bold transition-all"
                                >
                                    <Icon name="ArrowLeft" size={18} className="mr-2"/> 
                                    Kembali
                                </button>
                                <h2 className="text-5xl font-black leading-tight tracking-tighter">
                                    {isSignup 
                                        ? 'Mulakan Digitalisasi Tugasan Anda.' 
                                        : isForgot 
                                            ? 'Set Semula Password Anda.' 
                                            : 'Selamat Kembali ke PPM System.'
                                    }
                                </h2>
                            </div>
                            <p className="relative z-10 text-indigo-100 font-medium opacity-90 max-w-sm">
                                Platform ini membantu anda mengurus laporan harian dan mingguan dengan lebih efisien, sistematik dan pantas.
                            </p>
                            <div className="absolute top-0 right-0 w-80 h-80 bg-white/10 rounded-full -mr-40 -mt-40 blur-[100px]"></div>
                        </div>

                        {/* Right Side - Form Panel */}
                        <div className="md:w-1/2 flex items-center justify-center p-6 md:p-12 overflow-y-auto">
                            <div className="w-full max-w-md bg-white p-8 md:p-10 rounded-[40px] shadow-2xl shadow-indigo-100 border border-slate-100">
                                <h3 className="text-3xl font-black mb-8 text-slate-800 tracking-tight text-center">
                                    {isSignup 
                                        ? 'Daftar Akaun Baru' 
                                        : isForgot 
                                            ? 'Tukar Password' 
                                            : 'Log Masuk Sistem'
                                    }
                                </h3>

                                <form 
                                    onSubmit={async (e) => {
                                        e.preventDefault();
                                        const data = Object.fromEntries(new FormData(e.target));
                                        
                                        if (isSignup) {
                                            if (data.password.length !== 12) {
                                                return notify("Password mesti tepat 12 aksara!", "error");
                                            }
                                            const res = await callAPI('signup', data);
                                            if (res.success) {
                                                notify("Akaun anda berjaya didaftarkan");
                                                setPage('login');
                                            } else {
                                                notify(res.message, "error");
                                            }
                                        } else if (isForgot) {
                                            const res = await callAPI('forgotPassword', data);
                                            if (res.success) { 
                                                notify(res.message); 
                                                setPage('login'); 
                                            } else {
                                                notify(res.message, 'error');
                                            }
                                        } else {
                                            const res = await callAPI('login', data);
                                            if (res.success) {
                                                if (rememberMe) {
                                                    localStorage.setItem('ppm_remembered_username', data.username);
                                                } else {
                                                    localStorage.removeItem('ppm_remembered_username');
                                                }
                                                setUser(res.user);
                                                localStorage.setItem('ppm_user', JSON.stringify(res.user));
                                                setPage('app');
                                                fetchReports(res.user);
                                            } else {
                                                notify("Amaran: Username atau Password Salah!", "error");
                                            }
                                        }
                                    }} 
                                    className="space-y-4"
                                >
                                    {/* Full Name (Signup only) */}
                                    {isSignup && (
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                                Nama Penuh
                                            </label>
                                            <input 
                                                name="fullName" 
                                                placeholder="Nama Penuh" 
                                                className="w-full p-3.5 bg-slate-50 border-0 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 transition-all outline-none" 
                                                required 
                                            />
                                        </div>
                                    )}

                                    {/* Username */}
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                            Username {isSignup && '(Unik)'}
                                        </label>
                                        <input 
                                            name="username" 
                                            type="text"
                                            defaultValue={(!isSignup && !isForgot) ? savedUsername : ""}
                                            placeholder="Username" 
                                            className="w-full p-3.5 bg-slate-50 border-0 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 transition-all outline-none" 
                                            required 
                                        />
                                    </div>

                                    {/* Email (Signup only) */}
                                    {isSignup && (
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                                Alamat Emel
                                            </label>
                                            <input 
                                                name="email" 
                                                type="email" 
                                                placeholder="Alamat Emel" 
                                                className="w-full p-3.5 bg-slate-50 border-0 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 transition-all outline-none" 
                                                required 
                                            />
                                        </div>
                                    )}

                                    {/* Password */}
                                    <div className="space-y-1 relative">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                            Password {isSignup && '(12 Aksara)'}
                                        </label>
                                        <div className="relative">
                                            <input 
                                                name="password" 
                                                type={showPassword ? "text" : "password"}
                                                placeholder={isSignup ? "12 Aksara" : "Password"}
                                                maxLength={isSignup ? 12 : undefined}
                                                className="w-full p-3.5 bg-slate-50 border-0 rounded-2xl text-sm font-medium focus:ring-2 focus:ring-indigo-500 transition-all outline-none pr-12" 
                                                required 
                                            />
                                            <button 
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-3 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                            >
                                                <Icon name={showPassword ? "EyeOff" : "Eye"} size={16} className="text-slate-400" />
                                            </button>
                                        </div>
                                    </div>

                                    {/* Position & GPK (Signup only) */}
                                    {isSignup && (
                                        <>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                                    Jawatan
                                                </label>
                                                <select 
                                                    name="position" 
                                                    className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                                                >
                                                    <option value="PPM KELAS">PPM KELAS</option>
                                                    <option value="PPM ASRAMA">PPM ASRAMA</option>
                                                    <option value="PPM PRA">PPM PRA</option>
                                                    <option value="GPK">GPK</option>
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">
                                                    GPK Penilai
                                                </label>
                                                <select 
                                                    name="reportingGpk" 
                                                    className="w-full p-4 bg-slate-50 border-0 rounded-2xl font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                                                >
                                                    <option value="">Pilih GPK Penilai</option>
                                                    <option value="GPK PENTADBIRAN">GPK PENTADBIRAN</option>
                                                    <option value="GPK HAL EHWAL MURID">GPK HAL EHWAL MURID</option>
                                                    <option value="GPK KOKURIKULUM">GPK KOKURIKULUM</option>
                                                    <option value="-">TIADA PENILAI</option>
                                                </select>
                                            </div>
                                        </>
                                    )}

                                    {/* Remember Me (Login only) */}
                                    {!isSignup && !isForgot && (
                                        <div className="flex items-center px-2 py-2">
                                            <label className="flex items-center cursor-pointer group">
                                                <input 
                                                    type="checkbox" 
                                                    className="sr-only" 
                                                    checked={rememberMe} 
                                                    onChange={(e) => setRememberMe(e.target.checked)}
                                                />
                                                <div className={`w-10 h-6 rounded-full transition-colors ${
                                                    rememberMe ? 'bg-indigo-600' : 'bg-slate-200'
                                                }`}></div>
                                                <div className={`absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${
                                                    rememberMe ? 'translate-x-4' : ''
                                                }`}></div>
                                                <span className="ml-3 text-[10px] font-black text-slate-400 uppercase tracking-widest group-hover:text-slate-600">
                                                    Ingat Saya
                                                </span>
                                            </label>
                                        </div>
                                    )}

                                    {/* Submit Button */}
                                    <button 
                                        disabled={loading} 
                                        type="submit" 
                                        className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-xl flex items-center justify-center transition-all hover:bg-indigo-700 active:scale-95 mt-4 text-xs tracking-widest"
                                    >
                                        {loading ? (
                                            <div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                                        ) : (
                                            isSignup 
                                                ? 'Daftar Sekarang' 
                                                : (isForgot ? 'Simpan Password Baru' : 'Masuk Dashboard')
                                        )}
                                    </button>
                                    
                                    {/* Footer Links */}
                                    <div className="flex flex-col gap-3 pt-6 border-t border-slate-50">
                                        {!isSignup && !isForgot && (
                                            <button 
                                                type="button" 
                                                onClick={() => { 
                                                    setPage('forgot'); 
                                                    setShowPassword(false); 
                                                }} 
                                                className="text-[10px] font-black text-indigo-600 uppercase tracking-widest text-left"
                                            >
                                                Lupa Password?
                                            </button>
                                        )}
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            {isSignup 
                                                ? 'Sudah ada akaun?' 
                                                : (isForgot ? 'Ingat password?' : 'Tiada akaun?')
                                            }
                                            <button 
                                                type="button" 
                                                onClick={() => { 
                                                    setPage(isSignup || isForgot ? 'login' : 'signup'); 
                                                    setShowPassword(false); 
                                                }} 
                                                className="ml-2 text-indigo-600 font-black"
                                            >
                                                {isSignup || isForgot ? 'Log Masuk' : 'Daftar Sekarang'}
                                            </button>
                                        </p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main App Layout
            if (page === 'app') {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row overflow-hidden h-screen">
                        {/* Mobile Menu Toggle Button */}
                        <button 
                            onClick={() => setSidebarHidden(!sidebarHidden)}
                            className="fixed top-4 left-4 z-50 p-3 bg-indigo-600 text-white rounded-xl shadow-lg md:hidden hover:bg-indigo-700 transition-colors"
                        >
                            <Icon name={sidebarHidden ? "Menu" : "X"} size={24}/>
                        </button>

                        {/* Mobile Overlay */}
                        {!sidebarHidden && (
                            <div 
                                className="fixed inset-0 bg-black/20 backdrop-blur-sm z-30 md:hidden"
                                onClick={() => setSidebarHidden(true)}
                            />
                        )}

                        {/* Sidebar */}
                        <aside className={`fixed md:relative w-64 bg-white border-r border-slate-100 flex flex-col z-40 h-full transition-transform duration-300 ${
                            sidebarHidden ? '-translate-x-full md:translate-x-0' : 'translate-x-0'
                        }`}>
                            <div className="p-8 hidden md:block">
                                <h1 className="text-2xl font-black text-indigo-700 tracking-tighter">
                                    PPM SYSTEM
                                </h1>
                            </div>
                            
                            <nav className="flex-1 px-4 space-y-2 py-4 no-scrollbar overflow-y-auto">
                                <SidebarItem id="dashboard" icon="LayoutDashboard" label="Dashboard" />
                                <SidebarItem id="moment" icon="Camera" label="Moment" />
                                <SidebarItem id="jana" icon="FileText" label="Jana Laporan" roles={['User', 'Admin']} />
                                <SidebarItem id="semakan" icon="ClipboardCheck" label="Semakan" roles={['GPK', 'Admin', 'User']} />
                                {user?.role === 'Admin' && (
                                    <SidebarItem id="management" icon="Users" label="Pengurusan Akaun" />
                                )}
                                <SidebarItem id="profile" icon="UserCircle" label="Profil Saya" />
                            </nav>
                            
                            <div className="p-4 border-t border-slate-50">
                                <button 
                                    onClick={handleLogout} 
                                    className="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 font-bold transition-colors"
                                >
                                    <Icon name="LogOut" size={20} />
                                    <span className="text-sm">Log Keluar</span>
                                </button>
                            </div>
                        </aside>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto no-scrollbar relative p-6 md:p-10">
                            {/* Notification Toast */}
                            {notification && (
                                <div className={`fixed top-6 right-6 p-4 rounded-2xl shadow-2xl z-[200] border-l-8 flex items-center space-x-3 transition-all animate-in slide-in-from-right duration-300 ${
                                    notification.type === 'error' 
                                        ? 'bg-red-50 border-red-500 text-red-700' 
                                        : 'bg-emerald-50 border-emerald-500 text-emerald-700'
                                }`}>
                                    <Icon 
                                        name={notification.type === 'error' ? 'Plus' : 'CheckCircle'} 
                                        className={notification.type === 'error' ? 'rotate-45' : ''}
                                    />
                                    <span className="font-bold text-sm">{notification.msg}</span>
                                </div>
                            )}

                            {/* Status Banner for Pending/Suspended Users */}
                            {user && user.status !== 'Active' && <StatusBanner status={user.status} />}

                            {/* Mobile Header */}
                            <header className="flex md:hidden items-center justify-between mb-8 pt-16">
                                <h1 className="text-xl font-black text-indigo-700 tracking-tighter">
                                    PPM SYSTEM
                                </h1>
                                <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                                    {user?.username.substring(0,2).toUpperCase()}
                                </div>
                            </header>

                            {/* Page Content */}
                            <div className="max-w-6xl mx-auto pb-20">
                                {subPage === 'dashboard' && <Dashboard />}
                                {subPage === 'moment' && (
                                    <div className="flex flex-col items-center justify-center h-[70vh] text-slate-300 bg-white rounded-[40px] border-4 border-dashed border-slate-50">
                                        <Icon name="Camera" size={80} className="mb-6 opacity-20" />
                                        <p className="text-xl font-black">Moment Akan Datang</p>
                                        <p className="font-medium text-sm">Abadikan gambar tugasan anda di sini.</p>
                                    </div>
                                )}
                                {subPage === 'jana' && <JanaLaporan />}
                                {subPage === 'semakan' && <SemakanLaporan />}
                                {subPage === 'management' && user?.role === 'Admin' && <UserManagement />}
                                {subPage === 'profile' && (
                                    <ProfilePage 
                                        user={user} 
                                        setUser={setUser} 
                                        callAPI={callAPI} 
                                        notify={notify} 
                                    />
                                )}
                            </div>
                        </main>
                    </div>
                );
            }

            return null;
        }

        // ==========================================
        // REACT RENDER
        // ==========================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


            
            
        
