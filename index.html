<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PPM - Pengurusan Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbwQDoFSx5gDD07lbAM44u8A-2CTRHgXuvHArkPluWUsnbnh3q8i89v_yFNiwjRq_1Ce/exec";

        // --- UTILS ---
        const callAPI = async (action, payload, setLoading, notify) => {
            setLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({ action, payload })
                });
                const res = await response.json();
                setLoading(false);
                return res;
            } catch (err) {
                setLoading(false);
                notify("Ralat sambungan pangkalan data.", "error");
                return { success: false };
            }
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconHtml, setIconHtml] = useState("");
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                        const iconData = window.lucide.icons[name];
                        const content = iconData.map(([tag, attrs]) => {
                            const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                            return `<${tag} ${attrStr}></${tag}>`;
                        }).join('');
                        setIconHtml(`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${name.toLowerCase()} ${className}">${content}</svg>`);
                    }
                }, 10);
                return () => clearTimeout(timer);
            }, [name, size, className]);
            return <span className="inline-flex items-center justify-center" dangerouslySetInnerHTML={{ __html: iconHtml }} />;
        };

        // --- SUB-COMPONENTS ---

        const Dashboard = ({ reports }) => (
            <div className="space-y-6 fade-in">
                <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold text-slate-800">Ringkasan Prestasi</h2>
                    <div className="text-xs font-bold text-slate-400 bg-white px-4 py-2 rounded-full border shadow-sm">
                        {new Date().toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' })}
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Laporan Dibuat</p>
                        <p className="text-4xl font-black text-slate-800 mt-1">{reports.length}</p>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Menunggu Semakan</p>
                        <p className="text-4xl font-black text-orange-500 mt-1">{reports.filter(r => r.status === 'Submitted').length}</p>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Selesai Disemak</p>
                        <p className="text-4xl font-black text-emerald-500 mt-1">{reports.filter(r => r.status === 'Reviewed').length}</p>
                    </div>
                </div>
            </div>
        );

        const JanaLaporan = ({ reports, user, settings, callAPI, setLoading, notify, refreshReports }) => {
            const [view, setView] = useState('list');
            const [activeReport, setActiveReport] = useState(null);
            const [showLogForm, setShowLogForm] = useState(false);

            const handleCreateFolder = async (e) => {
                e.preventDefault();
                const d = Object.fromEntries(new FormData(e.target));
                const res = await callAPI('saveWeeklyFolder', { ...d, userId: user.uid }, setLoading, notify);
                if (res.success) {
                    notify("Tapak mingguan berjaya dicipta!");
                    refreshReports(user);
                    setView('list');
                } else notify(res.message, "error");
            };

            const handleAddLog = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const payload = {
                    reportId: activeReport.reportId,
                    userId: user.uid,
                    date: fd.get('date'),
                    day: new Date(fd.get('date')).toLocaleDateString('ms-MY', { weekday: 'long' }),
                    location: fd.get('location'),
                    attendance: fd.get('attendance'),
                    startTime: fd.get('startTime'),
                    endTime: fd.get('endTime'),
                    tasks: [
                        { m: fd.get('m1'), t: fd.get('t1'), c: fd.get('c1') },
                        { m: fd.get('m2'), t: fd.get('t2'), c: fd.get('c2') },
                        { m: fd.get('m3'), t: fd.get('t3'), c: fd.get('c3') },
                    ]
                };
                const res = await callAPI('saveDailyLog', payload, setLoading, notify);
                if (res.success) {
                    notify("Log harian berjaya disimpan!");
                    refreshReports(user);
                    setShowLogForm(false);
                    setView('list'); // Reset view to update data
                }
            };

            if (view === 'create') return (
                <div className="max-w-md mx-auto bg-white p-8 rounded-[40px] shadow-2xl border fade-in">
                    <h3 className="text-xl font-black mb-6">Cipta Tapak Minggu</h3>
                    <form onSubmit={handleCreateFolder} className="space-y-4">
                        <input name="year" type="number" defaultValue={new Date().getFullYear()} className="w-full p-4 bg-slate-50 rounded-2xl outline-none" required />
                        <select name="weekNum" className="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                            {[...Array(52)].map((_, i) => <option key={i+1} value={i+1}>Minggu {i+1}</option>)}
                        </select>
                        <div className="flex gap-2">
                            <button type="submit" className="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">Cipta</button>
                            <button type="button" onClick={() => setView('list')} className="flex-1 bg-slate-100 py-4 rounded-2xl font-bold">Batal</button>
                        </div>
                    </form>
                </div>
            );

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <h3 className="text-xl font-black text-slate-800">Laporan Mingguan Saya</h3>
                        <button onClick={() => setView('create')} className="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold flex items-center shadow-lg">
                            <Icon name="Plus" size={18} className="mr-2"/> Cipta Folder
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {reports.map((r) => (
                            <div key={r.reportId} className="bg-white rounded-[32px] shadow-sm border p-6 border-t-4 border-t-indigo-500 hover:shadow-xl transition-all">
                                <h4 className="text-2xl font-black text-slate-800">Minggu {r.weekNum}</h4>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Sesi {r.year}</p>
                                <div className="flex items-center mb-6">
                                    <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ${r.status === 'Reviewed' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>
                                        {r.status}
                                    </span>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => {setActiveReport(r); setShowLogForm(true);}} className="py-3 bg-indigo-50 text-indigo-700 rounded-2xl text-xs font-bold">Tambah Log</button>
                                    <button className="py-3 bg-slate-50 text-slate-600 rounded-2xl text-xs font-bold">Lihat</button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {showLogForm && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-2xl rounded-[40px] shadow-2xl max-h-[90vh] flex flex-col overflow-hidden">
                                <div className="p-6 bg-indigo-600 text-white flex justify-between items-center">
                                    <h3 className="font-bold">Tambah Log Harian</h3>
                                    <button onClick={() => setShowLogForm(false)}><Icon name="X" /></button>
                                </div>
                                <form onSubmit={handleAddLog} className="p-8 space-y-6 overflow-y-auto no-scrollbar">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="date" type="date" className="p-3 bg-slate-50 rounded-xl" required />
                                        <select name="location" className="p-3 bg-slate-50 rounded-xl">
                                            {settings.locations.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                        <input name="attendance" type="number" placeholder="Bil. Murid" className="p-3 bg-slate-50 rounded-xl" required />
                                        <div className="flex gap-2">
                                            <input name="startTime" type="time" className="flex-1 p-3 bg-slate-50 rounded-xl" required />
                                            <input name="endTime" type="time" className="flex-1 p-3 bg-slate-50 rounded-xl" required />
                                        </div>
                                    </div>
                                    {[1,2,3].map(i => (
                                        <div key={i} className="p-4 bg-slate-50 rounded-3xl space-y-2 border">
                                            <input name={`m${i}`} placeholder={`Waktu Tugasan ${i}`} className="w-full bg-transparent border-b outline-none text-sm font-bold" />
                                            <textarea name={`t${i}`} placeholder="Huraian Tugasan..." className="w-full p-3 rounded-xl border-0 text-sm h-20" required></textarea>
                                            <input name={`c${i}`} placeholder="Catatan/Impak" className="w-full p-2 rounded-xl text-xs italic bg-white" />
                                        </div>
                                    ))}
                                    <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Simpan Log</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ProfilePage = ({ user, callAPI, setLoading, notify, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({...user});

            const handleSave = async () => {
                if (formData.password?.length !== 12) return notify("Password mesti 12 aksara!", "error");
                const res = await callAPI('updateProfile', formData, setLoading, notify);
                if (res.success) {
                    onUpdate(formData);
                    setIsEditing(false);
                    notify("Profil berjaya dikemaskini!");
                }
            };

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-[40px] shadow-sm border overflow-hidden fade-in">
                    <div className="h-32 bg-indigo-600 relative">
                        <div className="absolute -bottom-12 left-1/2 -translate-x-1/2 w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center overflow-hidden border-4 border-white">
                            {formData.profilePic ? <img src={formData.profilePic} className="w-full h-full object-cover" /> : <Icon name="User" size={40} className="text-slate-200"/>}
                        </div>
                    </div>
                    <div className="pt-16 pb-10 px-8 space-y-6">
                        {!isEditing ? (
                            <div className="text-center space-y-4">
                                <div>
                                    <h2 className="text-2xl font-black text-slate-800">{user.fullName}</h2>
                                    <p className="text-indigo-600 font-bold uppercase text-[10px] tracking-widest">{user.position}</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                    <div className="p-4 bg-slate-50 rounded-2xl"><p className="text-[10px] text-slate-400 font-bold uppercase">Username</p><p className="font-bold">@{user.username}</p></div>
                                    <div className="p-4 bg-slate-50 rounded-2xl"><p className="text-[10px] text-slate-400 font-bold uppercase">Emel</p><p className="font-bold truncate">{user.email}</p></div>
                                </div>
                                <button onClick={() => setIsEditing(true)} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">Kemaskini Profil</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <input value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl outline-none" placeholder="Nama Penuh" />
                                <input value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl outline-none" placeholder="Emel" />
                                <input value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} maxLength={12} className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-mono" placeholder="Password Baru (12 Karakter)" />
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-bold">Simpan</button>
                                    <button onClick={() => setIsEditing(false)} className="flex-1 bg-slate-100 py-4 rounded-2xl font-bold">Batal</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [page, setPage] = useState('landing'); 
            const [subPage, setSubPage] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [reports, setReports] = useState([]);
            const [settings, setSettings] = useState({ locations: ["Kelas", "Asrama", "Padang", "Dewan", "Kantin"], gpks: [] });
            const [notification, setNotification] = useState(null);
            
            const [showPassword, setShowPassword] = useState(false);
            const [rememberMe, setRememberMe] = useState(false);
            const [savedUsername, setSavedUsername] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem('ppm_user');
                const remembered = localStorage.getItem('ppm_rem_user');
                if (remembered) { setSavedUsername(remembered); setRememberMe(true); }
                if (saved) {
                    const u = JSON.parse(saved);
                    setUser(u);
                    setPage('app');
                    fetchReports(u);
                }
                fetchInitialData();
            }, []);

            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const fetchInitialData = async () => {
                const res = await callAPI('getInitialData', {}, setLoading, notify);
                if (res.success) setSettings(prev => ({ ...prev, ...res }));
            };

            const fetchReports = async (currUser) => {
                const res = await callAPI('getReports', { userId: currUser.uid, role: currUser.role }, setLoading, notify);
                if (res.success) setReports(res.reports);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                const res = await callAPI('login', data, setLoading, notify);
                if (res.success) {
                    setUser(res.user);
                    localStorage.setItem('ppm_user', JSON.stringify(res.user));
                    if (rememberMe) localStorage.setItem('ppm_rem_user', data.username);
                    else localStorage.removeItem('ppm_rem_user');
                    setPage('app');
                    fetchReports(res.user);
                } else notify("Username atau Password Salah!", "error");
            };

            if (page === 'landing') return (
                <div className="min-h-screen bg-indigo-600 flex flex-col items-center justify-center p-6 text-white text-center">
                    <div className="bg-white/10 w-24 h-24 rounded-[32px] flex items-center justify-center mb-8 border border-white/20">
                        <Icon name="FileText" size={48} />
                    </div>
                    <h1 className="text-6xl font-black mb-4 tracking-tighter">SISTEM PPM</h1>
                    <p className="text-xl opacity-80 mb-12">Digitalisasi Laporan Pembantu Pengurusan Murid.</p>
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={() => setPage('login')} className="flex-1 py-4 bg-white text-indigo-700 font-black rounded-2xl shadow-xl">LOG MASUK</button>
                        <button className="flex-1 py-4 border-2 border-white/40 text-white font-black rounded-2xl">DAFTAR</button>
                    </div>
                </div>
            );

            if (page === 'login') return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                    <div className="w-full max-w-md bg-white p-10 rounded-[48px] shadow-2xl border">
                        <h3 className="text-3xl font-black mb-8 text-center text-slate-800">Log Masuk</h3>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input name="username" defaultValue={savedUsername} placeholder="Username" className="w-full p-4 bg-slate-50 rounded-2xl outline-none border focus:border-indigo-500" required />
                            <div className="relative">
                                <input name="password" type={showPassword ? "text" : "password"} placeholder="Password" className="w-full p-4 bg-slate-50 rounded-2xl outline-none border focus:border-indigo-500" required />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                                    <Icon name={showPassword ? "Eye" : "EyeOff"} size={18} />
                                </button>
                            </div>
                            <label className="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" checked={rememberMe} onChange={e => setRememberMe(e.target.checked)} className="rounded" />
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Ingat Saya</span>
                            </label>
                            <button disabled={loading} type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">
                                {loading ? "Sila Tunggu..." : "MASUK SEKARANG"}
                            </button>
                            <button type="button" onClick={() => setPage('landing')} className="w-full text-xs font-bold text-slate-400 uppercase mt-4">Kembali</button>
                        </form>
                    </div>
                </div>
            );

            if (page === 'app') return (
                <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row h-screen overflow-hidden">
                    <aside className="w-full md:w-64 bg-white border-r flex flex-col z-20">
                        <div className="p-8 font-black text-indigo-700 text-xl border-b tracking-tighter">PPM SYSTEM</div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto no-scrollbar">
                            {[
                                {id: 'dashboard', icon: 'LayoutDashboard', label: 'Dashboard'},
                                {id: 'jana', icon: 'FileText', label: 'Jana Laporan'},
                                {id: 'profile', icon: 'User', label: 'Profil Saya'}
                            ].map(item => (
                                <button key={item.id} onClick={() => setSubPage(item.id)} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-2xl transition-all ${subPage === item.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <Icon name={item.icon} /> <span className="font-bold text-sm">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={() => { localStorage.removeItem('ppm_user'); setUser(null); setPage('landing'); }} className="w-full flex items-center space-x-3 px-4 py-3 rounded-2xl text-red-500 font-bold hover:bg-red-50">
                                <Icon name="LogOut" /> <span className="text-sm">Log Keluar</span>
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 p-6 md:p-10 overflow-y-auto relative no-scrollbar">
                        {notification && (
                            <div className={`fixed top-6 right-6 p-4 rounded-2xl shadow-2xl z-[200] border-l-8 flex items-center space-x-3 fade-in ${notification.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' : 'bg-emerald-50 border-emerald-500 text-emerald-700'}`}>
                                <Icon name={notification.type === 'error' ? 'AlertCircle' : 'CheckCircle'} />
                                <span className="font-bold text-sm">{notification.msg}</span>
                            </div>
                        )}
                        <div className="max-w-6xl mx-auto">
                            {subPage === 'dashboard' && <Dashboard reports={reports} />}
                            {subPage === 'jana' && <JanaLaporan reports={reports} user={user} settings={settings} callAPI={callAPI} setLoading={setLoading} notify={notify} refreshReports={fetchReports} />}
                            {subPage === 'profile' && <ProfilePage user={user} callAPI={callAPI} setLoading={setLoading} notify={notify} onUpdate={(u) => {setUser(u); localStorage.setItem('ppm_user', JSON.stringify(u));}} />}
                        </div>
                        {loading && <div className="fixed bottom-10 right-10 bg-white p-4 rounded-full shadow-2xl flex items-center border animate-pulse"><Icon name="Loader" className="animate-spin text-indigo-600 mr-2"/> <span className="text-xs font-bold text-slate-500">Memproses...</span></div>}
                    </main>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
