<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem ePPM & GPK</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /************************************************************
         * 1. CONFIGURATION & UTILS
         ************************************************************/
        
        // PENTING: GANTIKAN URL INI DENGAN URL DEPLOYMENT GAS ANDA
        // Contoh: 'https://script.google.com/macros/s/AKfycbx.../exec'
        const API_URL = 'https://script.google.com/macros/s/AKfycbwQDoFSx5gDD07lbAM44u8A-2CTRHgXuvHArkPluWUsnbnh3q8i89v_yFNiwjRq_1Ce/exec';

        const ICONS = {
            user: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            lock: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>,
            mail: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>,
            menu: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            plus: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            trash: <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            edit: <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            check: <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            image: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            logOut: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            folder: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>,
            home: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            camera: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
            users: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        };

        const Spinner = () => (
            <div className="flex justify-center items-center p-4">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        );

        const Toast = ({ message, type, onClose }) => {
            if (!message) return null;
            const colors = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            return (
                <div className={`fixed top-4 right-4 ${colors} text-white px-6 py-3 rounded shadow-lg fade-in z-50 flex items-center`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="ml-4 font-bold">âœ•</button>
                </div>
            );
        };

        /************************************************************
         * 2. REUSABLE UI COMPONENTS
         ************************************************************/
        
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const base = "px-4 py-2 rounded font-medium transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-700 text-white shadow-sm",
                secondary: "bg-gray-200 hover:bg-gray-300 text-gray-800",
                danger: "bg-red-500 hover:bg-red-600 text-white",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, required = false, name }) => (
            <div className="mb-4">
                {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
            </div>
        );

        const Select = ({ label, value, onChange, options, name, required }) => (
            <div className="mb-4">
                {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <select
                    name={name}
                    value={value}
                    onChange={onChange}
                    required={required}
                    className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                >
                    <option value="">-- Sila Pilih --</option>
                    {options.map((opt, idx) => (
                        <option key={idx} value={opt.value}>{opt.label}</option>
                    ))}
                </select>
            </div>
        );

        const Card = ({ children, title, action }) => (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4 fade-in">
                {(title || action) && (
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        {title && <h3 className="text-lg font-semibold text-gray-800">{title}</h3>}
                        {action && <div>{action}</div>}
                    </div>
                )}
                {children}
            </div>
        );

        /************************************************************
         * 3. PAGE COMPONENTS: AUTH
         ************************************************************/

        const LoginPage = ({ onSwitch, onLogin, loading }) => {
            const [formData, setFormData] = React.useState({ username: '', password: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(formData);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 fade-in">
                        <h2 className="text-2xl font-bold text-center text-blue-900 mb-2">ePPM Login</h2>
                        <p className="text-center text-gray-500 mb-6">Sila log masuk ke akaun anda</p>
                        
                        <form onSubmit={handleSubmit}>
                            <Input 
                                label="Username" 
                                value={formData.username} 
                                onChange={e => setFormData({...formData, username: e.target.value})}
                                required
                            />
                            <Input 
                                label="Kata Laluan" 
                                type="password"
                                value={formData.password} 
                                onChange={e => setFormData({...formData, password: e.target.value})}
                                required
                            />
                            <Button type="submit" className="w-full" disabled={loading}>
                                {loading ? 'Memproses...' : 'Log Masuk'}
                            </Button>
                        </form>
                        
                        <div className="mt-4 flex justify-between text-sm text-blue-600">
                            <button onClick={() => onSwitch('signup')}>Daftar Akaun</button>
                            <button onClick={() => onSwitch('forgot')}>Lupa Kata Laluan?</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SignupPage = ({ onSwitch, onSignup, loading, initialData }) => {
            const [formData, setFormData] = React.useState({
                fullName: '', username: '', email: '', password: '', 
                position: 'PPM', reportingGpk: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSignup(formData);
            };

            const gpkOptions = (initialData.gpks || []).map(gpk => ({ value: gpk, label: gpk }));
            const positionOptions = [
                { value: 'PPM', label: 'PPM' },
                { value: 'GPK', label: 'GPK' },
                { value: 'Admin', label: 'Admin' }
            ];

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 fade-in">
                        <h2 className="text-2xl font-bold text-center text-blue-900 mb-6">Daftar Akaun Baru</h2>
                        <form onSubmit={handleSubmit}>
                            <Input label="Nama Penuh" value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} required />
                            <Input label="Username" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} required />
                            <Input label="Emel" type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                            <Input label="Kata Laluan" type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} required />
                            
                            <Select 
                                label="Jawatan"
                                value={formData.position}
                                onChange={e => setFormData({...formData, position: e.target.value})}
                                options={positionOptions}
                                required
                            />

                            {formData.position === 'PPM' && (
                                <Select 
                                    label="Melapor Kepada (GPK)"
                                    value={formData.reportingGpk}
                                    onChange={e => setFormData({...formData, reportingGpk: e.target.value})}
                                    options={gpkOptions}
                                    required={formData.position === 'PPM'}
                                />
                            )}

                            <Button type="submit" className="w-full" disabled={loading}>
                                {loading ? 'Mendaftar...' : 'Daftar'}
                            </Button>
                        </form>
                        <div className="mt-4 text-center text-sm">
                            <button onClick={() => onSwitch('login')} className="text-blue-600">Kembali ke Login</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ForgotPage = ({ onSwitch, onForgot, loading }) => {
            const [form, setForm] = React.useState({ username: '', newPassword: '' });

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 fade-in">
                        <h2 className="text-xl font-bold text-center mb-4">Lupa Kata Laluan</h2>
                        <form onSubmit={(e) => { e.preventDefault(); onForgot(form); }}>
                            <Input label="Username" value={form.username} onChange={e => setForm({...form, username: e.target.value})} required />
                            <Input label="Kata Laluan Baru" type="password" value={form.newPassword} onChange={e => setForm({...form, newPassword: e.target.value})} required />
                            <Button type="submit" className="w-full" disabled={loading}>Reset Password</Button>
                        </form>
                        <div className="mt-4 text-center">
                            <button onClick={() => onSwitch('login')} className="text-blue-600 text-sm">Batal</button>
                        </div>
                    </div>
                </div>
            );
        };

        /************************************************************
         * 4. FEATURE COMPONENTS: REPORTS & DASHBOARD
         ************************************************************/

        const DailyLogModal = ({ isOpen, onClose, onSave, log, locations }) => {
            if (!isOpen) return null;
            const [form, setForm] = React.useState(log || {
                date: new Date().toISOString().split('T')[0],
                day: '', location: '', attendance: 'Hadir', startTime: '08:00', endTime: '17:00', tasks: ''
            });

            React.useEffect(() => {
                if(log) setForm(log);
            }, [log]);

            // Auto calculate day from date
            React.useEffect(() => {
                if (form.date) {
                    const days = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
                    const d = new Date(form.date);
                    setForm(prev => ({...prev, day: days[d.getDay()]}));
                }
            }, [form.date]);

            const locOptions = locations.map(l => ({ value: l, label: l }));
            const attOptions = [
                { value: 'Hadir', label: 'Hadir' },
                { value: 'Cuti Rehat', label: 'Cuti Rehat' },
                { value: 'Cuti Sakit', label: 'Cuti Sakit' },
                { value: 'Kursus', label: 'Kursus' }
            ];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                    <div className="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-bold mb-4">{log ? 'Kemaskini Log' : 'Tambah Log Harian'}</h3>
                        <form onSubmit={(e) => { e.preventDefault(); onSave(form); }}>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Tarikh" type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} required />
                                <Input label="Hari" value={form.day} readOnly className="bg-gray-100" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Masa Mula" type="time" value={form.startTime} onChange={e => setForm({...form, startTime: e.target.value})} required />
                                <Input label="Masa Tamat" type="time" value={form.endTime} onChange={e => setForm({...form, endTime: e.target.value})} required />
                            </div>
                            <Select label="Kehadiran" value={form.attendance} options={attOptions} onChange={e => setForm({...form, attendance: e.target.value})} required />
                            <Select label="Lokasi" value={form.location} options={locOptions} onChange={e => setForm({...form, location: e.target.value})} required />
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Aktiviti / Tugas</label>
                                <textarea 
                                    className="w-full border rounded p-2 h-24" 
                                    value={form.tasks} 
                                    onChange={e => setForm({...form, tasks: e.target.value})}
                                    required
                                ></textarea>
                            </div>
                            
                            <div className="flex justify-end gap-2">
                                <Button variant="secondary" onClick={onClose}>Batal</Button>
                                <Button type="submit">{log ? 'Simpan Perubahan' : 'Tambah Log'}</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const WeeklyFolderView = ({ reports, onCreateFolder, onViewFolder, user }) => {
            // Generate next week suggestion
            const currentWeek = reports.length > 0 ? Math.max(...reports.map(r => r.weekNum)) + 1 : 1;
            
            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Laporan Mingguan</h2>
                        <Button onClick={() => onCreateFolder(currentWeek)}>
                            {ICONS.plus} Folder Minggu {currentWeek}
                        </Button>
                    </div>

                    {reports.length === 0 ? (
                        <div className="text-center py-10 text-gray-500">Tiada folder laporan. Sila cipta satu.</div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {reports.sort((a,b) => b.weekNum - a.weekNum).map(report => (
                                <div key={report.reportId} className="bg-white p-4 rounded-lg shadow hover:shadow-md transition cursor-pointer border border-gray-200" onClick={() => onViewFolder(report)}>
                                    <div className="flex items-center gap-3 mb-3">
                                        <div className="text-blue-500">{ICONS.folder}</div>
                                        <div>
                                            <h4 className="font-bold">Minggu {report.weekNum}</h4>
                                            <p className="text-xs text-gray-500">Tahun {report.year}</p>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className={`px-2 py-1 rounded text-xs font-semibold 
                                            ${report.status === 'Submitted' ? 'bg-green-100 text-green-700' : 
                                              report.status === 'Reviewed' ? 'bg-purple-100 text-purple-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                            {report.status}
                                        </span>
                                        <span className="text-gray-400">{report.logs?.length || 0} Log</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const ReportDetailView = ({ report, onBack, onAddLog, onUpdateLog, onDeleteLog, onSubmitReport, onUnsubmit, onReview, user, locations }) => {
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingLog, setEditingLog] = React.useState(null);

            const handleEdit = (log) => {
                setEditingLog(log);
                setIsModalOpen(true);
            };

            const handleAdd = () => {
                setEditingLog(null);
                setIsModalOpen(true);
            };

            const isOwner = user.uid === report.userId;
            const isEditable = isOwner && report.status === 'Draft';
            const isGPK = user.role === 'GPK';

            return (
                <div>
                    <button onClick={onBack} className="mb-4 text-blue-600 hover:underline flex items-center gap-1">
                        &larr; Kembali ke Senarai
                    </button>
                    
                    <Card 
                        title={`Laporan Minggu ${report.weekNum} - ${report.ownerName || user.fullName}`} 
                        action={
                            <div className="flex gap-2">
                                {isEditable && (
                                    <>
                                        <Button variant="outline" onClick={handleAdd}>{ICONS.plus} Tambah Log</Button>
                                        <Button onClick={() => onSubmitReport(report.reportId)}>Hantar Laporan</Button>
                                    </>
                                )}
                                {isOwner && report.status === 'Submitted' && (
                                    <Button variant="secondary" onClick={() => onUnsubmit(report.reportId)}>Batal Hantar</Button>
                                )}
                                {isGPK && report.status === 'Submitted' && (
                                    <Button onClick={() => onReview(report.reportId)}>Tanda Semak (Review)</Button>
                                )}
                            </div>
                        }
                    >
                        <div className="overflow-x-auto">
                            <table className="min-w-full text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="p-3 text-left">Tarikh / Hari</th>
                                        <th className="p-3 text-left">Masa</th>
                                        <th className="p-3 text-left">Lokasi</th>
                                        <th className="p-3 text-left">Aktiviti</th>
                                        <th className="p-3 text-left">Status</th>
                                        {isEditable && <th className="p-3 text-center">Tindakan</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {(report.logs || []).length === 0 ? (
                                        <tr><td colSpan="6" className="p-4 text-center text-gray-500">Tiada log harian.</td></tr>
                                    ) : (
                                        (report.logs || []).sort((a,b) => new Date(a.date) - new Date(b.date)).map(log => (
                                            <tr key={log.logId} className="border-t hover:bg-gray-50">
                                                <td className="p-3">
                                                    <div className="font-medium">{log.date}</div>
                                                    <div className="text-gray-500 text-xs">{log.day}</div>
                                                </td>
                                                <td className="p-3">{log.startTime} - {log.endTime}</td>
                                                <td className="p-3">{log.location}</td>
                                                <td className="p-3 whitespace-pre-wrap max-w-xs">{log.tasks}</td>
                                                <td className="p-3">{log.attendance}</td>
                                                {isEditable && (
                                                    <td className="p-3 flex justify-center gap-2">
                                                        <button onClick={() => handleEdit(log)} className="text-blue-600 hover:text-blue-800">{ICONS.edit}</button>
                                                        <button onClick={() => onDeleteLog(log.logId)} className="text-red-600 hover:text-red-800">{ICONS.trash}</button>
                                                    </td>
                                                )}
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    <DailyLogModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)}
                        locations={locations}
                        log={editingLog}
                        onSave={(data) => {
                            if (editingLog) onUpdateLog({...data, logId: editingLog.logId});
                            else onAddLog({...data, reportId: report.reportId, userId: user.uid});
                            setIsModalOpen(false);
                        }}
                    />
                </div>
            );
        };

        const MomentsGallery = ({ moments, onUpload, user, onDelete }) => {
            const [caption, setCaption] = React.useState('');
            const [file, setFile] = React.useState(null);
            const [uploading, setUploading] = React.useState(false);
            const fileInputRef = React.useRef(null);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if(f) setFile(f);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!file) return;
                setUploading(true);
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    onUpload({
                        imageBase64: base64,
                        username: user.username,
                        fullName: user.fullName,
                        caption: caption
                    });
                    setUploading(false);
                    setCaption('');
                    setFile(null);
                    if(fileInputRef.current) fileInputRef.current.value = '';
                };
            };

            return (
                <div>
                    <h2 className="text-2xl font-bold mb-6">Galeri Aktiviti (Moments)</h2>
                    
                    <Card>
                        <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-sm font-medium mb-1">Muat Naik Gambar</label>
                                <input 
                                    type="file" 
                                    ref={fileInputRef}
                                    accept="image/*"
                                    onChange={handleFileChange}
                                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                />
                            </div>
                            <div className="flex-1 w-full">
                                <Input label="Kapsyen" value={caption} onChange={e => setCaption(e.target.value)} placeholder="Aktiviti gotong royong..." />
                            </div>
                            <Button type="submit" disabled={!file || uploading}>
                                {uploading ? 'Uploading...' : 'Muat Naik'} {ICONS.camera}
                            </Button>
                        </form>
                    </Card>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {moments.map(m => (
                            <div key={m.momentId} className="bg-white rounded shadow overflow-hidden relative group">
                                <img src={m.imageUrl || 'https://via.placeholder.com/300'} alt="Moment" className="w-full h-48 object-cover" />
                                <div className="p-3">
                                    <p className="font-bold text-sm truncate">{m.fullName}</p>
                                    <p className="text-gray-600 text-xs">{m.caption}</p>
                                    <p className="text-gray-400 text-[10px] mt-1">{new Date(m.createdAt).toLocaleDateString()}</p>
                                </div>
                                {(user.role === 'Admin' || user.username === m.username) && (
                                    <button 
                                        onClick={() => onDelete(m.momentId)}
                                        className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition"
                                    >
                                        {ICONS.trash}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ users, onManageUser }) => {
            return (
                <div>
                    <h2 className="text-2xl font-bold mb-6">Admin Panel - Pengurusan Pengguna</h2>
                    <div className="bg-white rounded shadow overflow-x-auto">
                        <table className="min-w-full text-sm">
                            <thead className="bg-gray-100 border-b">
                                <tr>
                                    <th className="p-3 text-left">Nama / Emel</th>
                                    <th className="p-3 text-left">Jawatan</th>
                                    <th className="p-3 text-left">Status</th>
                                    <th className="p-3 text-left">GPK</th>
                                    <th className="p-3 text-center">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody>
                                {users.map(u => (
                                    <tr key={u.uid} className="border-b hover:bg-gray-50">
                                        <td className="p-3">
                                            <div className="font-bold">{u.fullName}</div>
                                            <div className="text-gray-500 text-xs">{u.email}</div>
                                        </td>
                                        <td className="p-3">{u.position}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded text-xs ${
                                                u.status === 'Approved' ? 'bg-green-100 text-green-700' : 
                                                u.status === 'Pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                            }`}>
                                                {u.status}
                                            </span>
                                        </td>
                                        <td className="p-3">{u.reportingGpk || '-'}</td>
                                        <td className="p-3 flex justify-center gap-2">
                                            {u.status === 'Pending' && (
                                                <>
                                                    <Button variant="primary" className="text-xs px-2 py-1" onClick={() => onManageUser('approveUser', u.uid)}>Approve</Button>
                                                    <Button variant="danger" className="text-xs px-2 py-1" onClick={() => onManageUser('rejectUser', u.uid)}>Reject</Button>
                                                </>
                                            )}
                                            {u.status === 'Approved' && (
                                                <Button variant="secondary" className="text-xs px-2 py-1" onClick={() => onManageUser('suspendUser', u.uid)}>Suspend</Button>
                                            )}
                                            {u.status === 'Suspended' && (
                                                <Button variant="primary" className="text-xs px-2 py-1" onClick={() => onManageUser('reactivateUser', u.uid)}>Activate</Button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const GPKDashboard = ({ summary, ppmList, onSelectPPM }) => {
            return (
                <div>
                    <h2 className="text-2xl font-bold mb-6">Dashboard GPK</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <Card title="Jumlah PPM">
                            <div className="text-3xl font-bold text-blue-600">{summary.totalPpm || 0}</div>
                        </Card>
                        <Card title="Laporan Dihantar (Minggu Ini)">
                            <div className="text-3xl font-bold text-green-600">{summary.submittedCount || 0}</div>
                        </Card>
                        <Card title="Belum Hantar">
                            <div className="text-3xl font-bold text-red-600">{summary.pendingCount || 0}</div>
                        </Card>
                    </div>

                    <h3 className="text-xl font-bold mb-4">Senarai PPM & Status Laporan</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {ppmList.map(ppm => (
                            <div key={ppm.uid} className="bg-white p-4 rounded shadow hover:shadow-md cursor-pointer border-l-4 border-blue-500"
                                onClick={() => onSelectPPM(ppm)}>
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-gray-800">{ppm.fullName}</h4>
                                    <span className="text-xs bg-gray-100 px-2 py-1 rounded">{ppm.username}</span>
                                </div>
                                <div className="text-sm text-gray-600 mb-2">
                                    Status Minggu Ini: <span className="font-semibold">{ppm.displayStatus || 'Tiada'}</span>
                                </div>
                                <button className="text-blue-600 text-sm hover:underline mt-2">Lihat Folder Laporan &rarr;</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        /************************************************************
         * 5. MAIN APP CONTROLLER
         ************************************************************/

        const App = () => {
            // GLOBAL STATE
            const [page, setPage] = React.useState('login'); // login, signup, forgot, dashboard
            const [subPage, setSubPage] = React.useState('home'); // home, reports, moments, admin, profile
            
            // DATA STATE
            const [user, setUser] = React.useState(null);
            const [initialData, setInitialData] = React.useState({ locations: [], gpks: [] });
            const [reports, setReports] = React.useState([]);
            const [selectedReport, setSelectedReport] = React.useState(null); // Drill down
            const [moments, setMoments] = React.useState([]);
            const [adminUsers, setAdminUsers] = React.useState([]);
            const [gpkData, setGpkData] = React.useState({ summary: {}, ppmList: [] });

            // UI STATE
            const [loading, setLoading] = React.useState(false);
            const [toast, setToast] = React.useState({ msg: '', type: '' });

            // --- API HELPER ---
            const callApi = async (action, payload = {}) => {
                // GUARD: Check if user replaced the placeholder
                if (API_URL.includes('<<')) {
                    showToast("Ralat: Sila ganti '<<URL WEB APP GAS>>' dengan URL sebenar di dalam kod.", "error");
                    console.error("API_URL belum dikonfigurasi. Sila edit baris: const API_URL = '...';");
                    return { success: false };
                }

                setLoading(true);
                try {
                    console.log(`API Call: ${action}`, payload);
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        // headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Kadang kala perlu untuk GAS
                        body: JSON.stringify({ action, payload })
                    });
                    const data = await res.json();
                    if (!data) throw new Error("No data returned");
                    return data;
                } catch (e) {
                    console.error("API Error", e);
                    showToast(e.message || "Ralat Sambungan", "error");
                    return { success: false };
                } finally {
                    setLoading(false);
                }
            };

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast({ msg: '', type: '' }), 3000);
            };

            // --- EFFECTS ---
            React.useEffect(() => {
                // Fetch initial dropdown data on load
                // Only call if API_URL is set correctly to avoid spamming errors on load
                if (!API_URL.includes('<<')) {
                    callApi('getInitialData').then(res => {
                        if (res) setInitialData(res);
                    });
                }
            }, []);

            React.useEffect(() => {
                if (user && page === 'dashboard') {
                    // Load data based on role
                    if(subPage === 'home' || subPage === 'reports') fetchReports();
                    if(subPage === 'moments') fetchMoments();
                    if(subPage === 'admin' && user.role === 'Admin') fetchAdminUsers();
                    if(subPage === 'home' && user.role === 'GPK') fetchGpkDashboard();
                }
            }, [user, page, subPage]);

            // --- DATA FETCHERS ---
            const fetchReports = async () => {
                if(!user) return;
                const res = await callApi('getReports', { userId: user.uid, role: user.role });
                if(res && res.reports) setReports(res.reports);
            };

            const fetchMoments = async () => {
                const res = await callApi('getMoments', {});
                if(res && res.moments) setMoments(res.moments);
            };

            const fetchAdminUsers = async () => {
                const res = await callApi('getAllUsersForAdmin', { requesterId: user.uid });
                if(res && res.users) setAdminUsers(res.users);
            };

            const fetchGpkDashboard = async () => {
                const res = await callApi('getGPKDashboard', { 
                    gpkReportingValue: user.fullName, 
                    year: new Date().getFullYear(),
                    weekNum: 0 // 0 means auto latest
                });
                if(res) {
                    setGpkData({
                        summary: { totalPpm: res.ppmList?.length, submittedCount: 0, pendingCount: 0 }, // Simplified logic
                        ppmList: res.ppmList || []
                    });
                }
            };

            // --- AUTH HANDLERS ---
            const handleLogin = async (creds) => {
                const res = await callApi('login', creds);
                if (res.success) {
                    setUser(res.user);
                    setPage('dashboard');
                    setSubPage('home');
                } else if (res.needsVerification) {
                    showToast("Sila sahkan emel anda dahulu.", "error");
                } else {
                    showToast("Login gagal. Semak maklumat anda.", "error");
                }
            };

            const handleSignup = async (data) => {
                const res = await callApi('signup', data);
                if (res.success || res.message) { // Handle variable GAS response
                    showToast("Pendaftaran berjaya! Sila login.", "success");
                    setPage('login');
                } else {
                    showToast("Pendaftaran gagal.", "error");
                }
            };

            const handleLogout = () => {
                setUser(null);
                setPage('login');
                setReports([]);
            };

            // --- REPORT ACTIONS ---
            const createFolder = async (weekNum) => {
                const year = new Date().getFullYear();
                const res = await callApi('saveWeeklyFolder', { userId: user.uid, year, weekNum });
                if(res.success) {
                    showToast("Folder berjaya dicipta");
                    fetchReports();
                }
            };

            const saveLog = async (logData) => {
                // Determine if add or update
                const action = logData.logId ? 'updateDailyLog' : 'saveDailyLog';
                const res = await callApi(action, logData);
                if(res.success) {
                    showToast("Log disimpan");
                    // Refresh current report logs locally or re-fetch
                    fetchReports();
                    // Also update selectedReport if open
                    if (selectedReport) {
                        // Quick hack: re-fetch reports and find specific one
                        const updatedReports = await callApi('getReports', { userId: user.uid, role: user.role });
                        if(updatedReports && updatedReports.reports) {
                            const updated = updatedReports.reports.find(r => r.reportId === selectedReport.reportId);
                            if(updated) setSelectedReport(updated);
                        }
                    }
                }
            };

            const deleteLog = async (logId) => {
                if(!confirm("Anda pasti hapuskan log ini?")) return;
                const res = await callApi('deleteDailyLog', { logId });
                if(res.success) {
                    showToast("Log dipadam");
                    fetchReports();
                    // Close view or refresh
                    setSelectedReport(null); 
                }
            };

            const submitReport = async (reportId) => {
                if(!confirm("Hantar laporan kepada GPK? Anda tidak boleh edit selepas ini.")) return;
                const res = await callApi('submitReport', { reportId });
                if(res.success) {
                    showToast("Laporan dihantar!");
                    fetchReports();
                    setSelectedReport(null);
                }
            };

             const unsubmitReport = async (reportId) => {
                const res = await callApi('unreportReport', { reportId });
                if(res.success) {
                    showToast("Status dikembalikan ke Draft");
                    fetchReports();
                    setSelectedReport(null);
                }
            };

            const reviewReport = async (reportId) => {
                const res = await callApi('reviewReport', { reportId, gpkName: user.fullName });
                if(res.success) {
                    showToast("Laporan telah disemak");
                    fetchReports();
                    setSelectedReport(null);
                }
            };

            // --- OTHER ACTIONS ---
            const handleUploadMoment = async (payload) => {
                const res = await callApi('uploadMoment', payload);
                if(res.success) {
                    showToast("Moment dimuat naik!");
                    fetchMoments();
                }
            };

            const deleteMoment = async (momentId) => {
                if(!confirm("Padam gambar ini?")) return;
                const res = await callApi('deleteMoment', { momentId });
                if(res.success) {
                    showToast("Moment dipadam");
                    fetchMoments();
                }
            };

            const manageUser = async (actionName, userId) => {
                const res = await callApi(actionName, { adminId: user.uid, userId });
                if(res.success) {
                    showToast("Tindakan admin berjaya");
                    fetchAdminUsers();
                }
            };

            // --- RENDER HELPERS ---
            const renderDashboardContent = () => {
                if (selectedReport) {
                    return (
                        <ReportDetailView 
                            report={selectedReport} 
                            user={user}
                            locations={initialData.locations || []}
                            onBack={() => setSelectedReport(null)}
                            onAddLog={saveLog}
                            onUpdateLog={saveLog}
                            onDeleteLog={deleteLog}
                            onSubmitReport={submitReport}
                            onUnsubmit={unsubmitReport}
                            onReview={reviewReport}
                        />
                    );
                }

                switch (subPage) {
                    case 'home':
                        if (user.role === 'GPK') {
                            return (
                                <GPKDashboard 
                                    summary={gpkData.summary} 
                                    ppmList={gpkData.ppmList} 
                                    onSelectPPM={async (ppm) => {
                                        // Load reports for this PPM
                                        const res = await callApi('getReports', { userId: ppm.uid, role: 'PPM' }); // View as PPM data
                                        if (res && res.reports) {
                                            // Show folder view for this PPM
                                            // Hack: We repurpose the reports state briefly or need a new mode
                                            // Easier: Just set reports to this user's reports and let standard view handle it, 
                                            // but we need to know we are viewing someone else.
                                            // For simplicity in this single file:
                                            alert("Fitur melihat folder PPM spesifik akan membuka senarai folder mereka.");
                                            setReports(res.reports);
                                        }
                                    }}
                                />
                            );
                        }
                        // Fallthrough for PPM & Admin to see their reports/dashboard
                        return (
                            <WeeklyFolderView 
                                reports={reports.filter(r => r.userId === user.uid)} 
                                user={user}
                                onCreateFolder={createFolder}
                                onViewFolder={setSelectedReport}
                            />
                        );
                    
                    case 'moments':
                        return <MomentsGallery moments={moments} onUpload={handleUploadMoment} user={user} onDelete={deleteMoment} />;
                    
                    case 'admin':
                        return user.role === 'Admin' ? <AdminPanel users={adminUsers} onManageUser={manageUser} /> : <div>Akses Ditolak</div>;
                    
                    default:
                        return <div>Halaman tidak ditemui</div>;
                }
            };

            // --- MAIN RENDER ---
            return (
                <div className="min-h-screen text-gray-800 font-sans">
                    {loading && (
                        <div className="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50">
                            <Spinner />
                        </div>
                    )}
                    
                    <Toast message={toast.msg} type={toast.type} onClose={() => setToast({ msg: '', type: '' })} />

                    {/* ROUTING LOGIC */}
                    {page === 'login' && <LoginPage onSwitch={setPage} onLogin={handleLogin} loading={loading} />}
                    {page === 'signup' && <SignupPage onSwitch={setPage} onSignup={handleSignup} loading={loading} initialData={initialData} />}
                    {page === 'forgot' && <ForgotPage onSwitch={setPage} onForgot={(d) => callApi('forgotPassword', d).then(r => r.success && showToast('Semak emel anda.'))} loading={loading} />}
                    
                    {page === 'dashboard' && user && (
                        <div className="flex h-screen overflow-hidden">
                            {/* SIDEBAR */}
                            <aside className="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
                                <div className="p-6 border-b flex items-center gap-3">
                                    <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                                        {user.fullName.charAt(0)}
                                    </div>
                                    <div>
                                        <h1 className="font-bold text-sm truncate w-32">{user.fullName}</h1>
                                        <p className="text-xs text-gray-500">{user.role}</p>
                                    </div>
                                </div>
                                <nav className="flex-1 p-4 space-y-2">
                                    <button onClick={() => { setSubPage('home'); setSelectedReport(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition ${subPage === 'home' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}`}>
                                        {ICONS.home} Utama
                                    </button>
                                    <button onClick={() => setSubPage('moments')} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition ${subPage === 'moments' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}`}>
                                        {ICONS.image} Galeri Moments
                                    </button>
                                    {user.role === 'Admin' && (
                                        <button onClick={() => setSubPage('admin')} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition ${subPage === 'admin' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}`}>
                                            {ICONS.users} Admin Panel
                                        </button>
                                    )}
                                </nav>
                                <div className="p-4 border-t">
                                    <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded transition">
                                        {ICONS.logOut} Log Keluar
                                    </button>
                                </div>
                            </aside>

                            {/* MOBILE HEADER */}
                            <div className="flex-1 flex flex-col h-screen overflow-hidden">
                                <header className="bg-white border-b p-4 flex md:hidden justify-between items-center">
                                    <h1 className="font-bold text-lg">ePPM System</h1>
                                    <button onClick={handleLogout}>{ICONS.logOut}</button>
                                </header>
                                <div className="md:hidden flex overflow-x-auto bg-white border-b">
                                    <button onClick={() => setSubPage('home')} className={`flex-1 py-3 text-center text-sm ${subPage === 'home' ? 'border-b-2 border-blue-500 font-bold' : ''}`}>Utama</button>
                                    <button onClick={() => setSubPage('moments')} className={`flex-1 py-3 text-center text-sm ${subPage === 'moments' ? 'border-b-2 border-blue-500 font-bold' : ''}`}>Galeri</button>
                                    {user.role === 'Admin' && <button onClick={() => setSubPage('admin')} className={`flex-1 py-3 text-center text-sm ${subPage === 'admin' ? 'border-b-2 border-blue-500 font-bold' : ''}`}>Admin</button>}
                                </div>

                                {/* MAIN CONTENT */}
                                <main className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 relative">
                                    {user.status !== 'Approved' ? (
                                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow">
                                            <p className="font-bold">Akaun Belum Aktif</p>
                                            <p>Akaun anda berstatus: <strong>{user.status}</strong>. Sila tunggu kelulusan Admin.</p>
                                        </div>
                                    ) : (
                                        renderDashboardContent()
                                    )}
                                </main>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
